function numberToAlphabet(e){return(e=parseInt(Math.max(-25,Math.min(26,e))))<=0?String.fromCharCode(CHARCODE_a+e+25):String.fromCharCode(CHARCODE_A+e-1)}function alphabetToNumber(e="a"){const t=e.charCodeAt(e);let a;return a=t<CHARCODE_a?t-CHARCODE_A+1:t-CHARCODE_a-25,parseInt(Math.max(-25,Math.min(26,a)))}function getElementsCenterPageXY(e){const t=document.scrollingElement||document.documentElement||document.body,a=t.scrollLeft,n=t.scrollTop,o=e.getBoundingClientRect();return{x:(o.left+o.right)/2+a,y:(o.top+o.bottom)/2+n}}function getPageXY(e){return{x:"pageX"in e?e.pageX:e.targetTouches&&e.targetTouches.length?e.targetTouches[0].pageX:lastTouchEvent.targetTouches&&lastTouchEvent.targetTouches.length?lastTouchEvent.targetTouches[0].pageX:0,y:"pageY"in e?e.pageY:e.targetTouches&&e.targetTouches.length?e.targetTouches[0].pageY:lastTouchEvent.targetTouches&&lastTouchEvent.targetTouches.length?lastTouchEvent.targetTouches[0].pageY:0}}function canvasXYToPageXY(e,t){"object"==typeof e&&(t=e.y,e=e.x);const a=$("#canvas-container"),n=document.scrollingElement||document.documentElement||document.body,o=n.scrollLeft,s=n.scrollTop,r=a.get(0).getBoundingClientRect();return{x:e+r.left+o,y:t+r.top+s}}function pageXYToCanvasXY(e,t){"object"==typeof e&&(t=e.y,e=e.x);const a=$canvasContainer,n=document.scrollingElement||document.documentElement||document.body,o=n.scrollLeft,s=n.scrollTop,r=a.get(0).getBoundingClientRect();return getMultipliedVector({x:e-r.left-o,y:t-r.top-s},1/$canvasContainer.elmvar("scale"))}function getMultipliedVector(e,t){return{x:e.x*t,y:e.y*t}}function getMultipliedWH(e,t){return{width:e.width*t,height:e.height*t}}function canvasXYToStageXY(e,t){"object"==typeof e&&(t=e.y,e=e.x);const a=canvasSetting,n=getRotatedVector({x:e-(a.canvasWidth/2+a.stageX),y:t-(a.canvasHeight/2+a.stageY)},-a.stageRotate);return{x:1200+n.x/a.stageScale,y:1200+n.y/a.stageScale}}function stageXYToCanvasXY(e,t){"object"==typeof e&&(t=e.y,e=e.x);const a=canvasSetting,n=getRotatedVector({x:e-1200,y:t-1200},a.stageRotate);return vec3={x:a.canvasWidth/2+a.stageX+n.x*a.stageScale,y:a.canvasHeight/2+a.stageY+n.y*a.stageScale}}function pageXYToStageXY(e,t){"object"==typeof e&&(t=e.y,e=e.x);const a=pageXYToCanvasXY(e,t);return canvasXYToStageXY(a.x,a.y)}function getDistance(e,t={x:0,y:0}){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))}function parseIntVec(e){return{x:parseInt(e.x),y:parseInt(e.y)}}function getVectorAngle(e){const t=Math.asin(e.y/getDistance(e))*(180/Math.PI);return e.y>=0?e.x>0?t:180-t:e.x>0?360-Math.abs(t):180+Math.abs(t)}function getRotatedVector(e,t){const a=t*(Math.PI/180),n=Math.sin(a),o=Math.cos(a);return{x:-n*e.y+o*e.x,y:n*e.x+o*e.y}}function createShadowPositions(e,t,a){const n=void 0!==a?a:Math.PI/4,o=e*Math.PI*2,s=void 0!==t?t:Math.max(4,Math.round(o/3)),r=[];for(let t=0;t<s;t++){const a=2*Math.PI*t/s,o=Math.cos(a+n)*e,i=Math.sin(a+n)*e;r.push([o,i])}return r}function getQueries(e){const t=String(e||window.location),a=t.slice(t.indexOf("?")+1),n={};return a?(a.split("&").forEach(e=>{const t=e.split("=");n[t[0]]=t[1]}),n):n}function getDepthValueByImagedata(e,t,a){const n=null===a?parseInt(t):4*(parseInt(t)+parseInt(a)*e.width);return(65536*e.data[n+0]+256*e.data[n+1]+e.data[n+2]-8388608)/1e4}function depthValueToRGB(e){let t=1e4*e+8388608;const a=Math.floor(t/65536);t-=65536*a;const n=Math.floor(t/256);return[a,n,t-=256*n]}function createCanvas(e,t){const a=document.createElement("canvas");a.width=e,a.height=t;const n=a.getContext("2d");return n.canvas=a,n.clear=(()=>{n.clearRect(0,0,a.width,a.height)}),[a,n]}function downloadText(e,t){const a=new Blob([e],{type:"text/plain"});if(void 0!==window.navigator.msSaveBlob)return window.navigator.msSaveBlob(a,t);const n=document.createElement("a");n.href=URL.createObjectURL(a),n.download=t;const o=document.createEvent("MouseEvents");o.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),n.dispatchEvent(o)}function downloadCanvas(e,t="canvas",a="image/png"){const n=getBlobFromCanvas(e,a),o=window.URL.createObjectURL(n),s=document.createElementNS("http://www.w3.org/1999/xhtml","a");s.href=o,s.download=t;const r=document.createEvent("MouseEvents");r.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),s.dispatchEvent(r)}function getBlobFromCanvas(e,t="image/png"){const a=("string"==typeof e?document.getElementById(e):e).toDataURL(t).split(","),n=atob(a[1]),o=a[0].split(":")[1].split(";")[0];let s=new Uint8Array(n.length);for(let e=0;e<n.length;e++)s[e]=n.charCodeAt(e);return new Blob([s],{type:o})}function closeMyConfirm(){$("#confirm").hide()}function myConfirm(e){e=$.extend({textOK:"OK",textNG:"Cancel",funcOK:()=>{},funcNG:()=>{},textInput:""},e);const t=$("#confirm"),a=t.find("input"),n=t.find(".button-ok"),o=t.find(".button-ng");a.val(e.textInput),n.get(0).onclick=(t=>{const n=a.val();e.funcOK(n),closeMyConfirm(n)}),o.get(0).onclick=(t=>{const n=a.val();e.funcNG(n),closeMyConfirm(n)}),t.show()}function getDateStr(){const e=new Date;let t=e.getFullYear(),a=e.getMonth()+1,n=e.getDate(),o=e.getHours(),s=e.getMinutes(),r=e.getSeconds();return`${t=""+t}_${a=("00"+a).slice(-2)}_${n=("00"+n).slice(-2)}_${o=("00"+o).slice(-2)}_${s=("00"+s).slice(-2)}_${r=("00"+r).slice(-2)}`}function parseTimestamp(e){const t=new Date(e);let a=t.getFullYear(),n=t.getMonth()+1,o=t.getDate(),s=t.getHours(),r=t.getMinutes(),i=t.getSeconds();return`${a=""+a}/${n=("00"+n).slice(-2)}/${o=("00"+o).slice(-2)} ${s=("00"+s).slice(-2)}:${r=("00"+r).slice(-2)}:${i=("00"+i).slice(-2)}`}function copyStr(e){const t=document.createElement("div"),a=document.createElement("pre");a.style.webkitUserSelect="auto",a.style.userSelect="auto",t.appendChild(a).textContent=e;const n=t.style;n.position="fixed",n.right="200%",document.body.appendChild(t),document.getSelection().selectAllChildren(t);const o=document.execCommand("copy");return document.body.removeChild(t),o}!function(e){e&&e.prototype&&(e.prototype.fillRoundRect=function(e,t,a,n,o){this.beginPath(),this.moveTo(e+o,t),this.lineTo(e+a-o,t),this.arc(e+a-o,t+o,o,1.5*Math.PI,0,!1),this.lineTo(e+a,t+n-o),this.arc(e+a-o,t+n-o,o,0,.5*Math.PI,!1),this.lineTo(e+o,t+n),this.arc(e+o,t+n-o,o,.5*Math.PI,Math.PI,!1),this.lineTo(e,t+o),this.arc(e+o,t+o,o,Math.PI,1.5*Math.PI,!1),this.closePath(),this.fill()},e.prototype.fillCircle=function(e,t,a){this.beginPath(),this.arc(e,t,a,0,2*Math.PI,!1),this.closePath(),this.fill()},e.prototype.drawImageCenter=function(e,t,a,n,o){this.drawImage(e,t-n/2,a-o/2,n,o)},e.prototype.drawImageBorder=function(e,t,a,n,o,s,r){if(!s)return this.drawImage(e,t,a,n,o);this.shadowColor=r,this.shadowBlur=0,createShadowPositions(s+1).forEach((s,r)=>{this.shadowOffsetX=parseFloat(s[0].toFixed(1)),this.shadowOffsetY=parseFloat(s[1].toFixed(1)),this.drawImage(e,t,a,n,o)}),this.shadowColor="transparent"},e.prototype.drawImageCenterBorder=function(e,t,a,n,o,s,r){if(!s)return this.drawImageCenter(e,t,a,n,o);this.shadowColor=r,this.shadowBlur=0,createShadowPositions(s+1).forEach((s,r)=>{this.shadowOffsetX=parseFloat(s[0].toFixed(1)),this.shadowOffsetY=parseFloat(s[1].toFixed(1)),this.drawImageCenter(e,t,a,n,o)}),this.shadowColor="transparent"},e.prototype.arrow=function(e,t,a,n,o){const s=a-e,r=n-t,i=Math.sqrt(s*s+r*r),l=r/i,c=s/i,g=[];g.push(0,0);for(let e=0;e<o.length;e+=2){const t=o[e],a=o[e+1];g.push(t<0?i+t:t,a)}g.push(i,0);for(let e=o.length;e>0;e-=2){const t=o[e-2],a=o[e-1];g.push(t<0?i+t:t,-a)}g.push(0,0);for(let a=0;a<g.length;a+=2){const n=g[a]*c-g[a+1]*l+e,o=g[a]*l+g[a+1]*c+t;0===a?this.moveTo(n,o):this.lineTo(n,o)}})}(CanvasRenderingContext2D);const VERSION="0.2.1",STORAGE_KEY="salmon_map",STORAGE_KEY_AUTOSAVE="salmon_map_autosave",STORAGE_KEY_JSONSAVE="salmon_map_jsonsave",AUTOSAVE_INTERVAL=3e3,CHARCODE_a="a".charCodeAt(0),CHARCODE_A="A".charCodeAt(0),DEFAULT_SAVEDATAOBJ={stage:"shakeup",tide:"normal",maptype:"floorplan","checkbox-layer-basket":!0,"checkbox-layer-cannon":!0,"checkbox-layer-gusher":!0,"checkbox-layer-drizzler-link":!1,"checkbox-layer-voronoi":!1,"checkbox-layer-drizzler":!1,"checkbox-layer-flyfish":!1,"checkbox-layer-spawner":!1,"checkbox-layer-mothership":!1,"checkbox-layer-rail":!0,"checkbox-layer-startpos":!1,"checkbox-layer-stinger":!1},DEFAULT_MAP_TRANSFORM={"shakeup-high":[300,75,.9,0,151],"shakeup-normal":[145,75,.6,0,90],"shakeup-low":[-41,300,.7,-123,64],"shakeship-high":[0,-32,.86,-90,123],"shakeship-normal":[55,0,.62,-90,89],"shakeship-low":[10,380,.7,90,65],"shakehouse-high":[10,75,.85,90,133],"shakehouse-normal":[0,75,.51,90,112],"shakehouse-low":[160,470,.85,-90,61],"shakelift-high":[165,-100,1,180,116],"shakelift-normal":[120,-145,.75,180,75],"shakelift-low":[-70,340,.8,90,36],"shakeride-high":[10,300,1.1,0,217],"shakeride-normal":[15,290,.7,0,98],"shakeride-low":[40,280,.75,180,68]},USER_LANG=(getQueries().lang||navigator.language||navigator.USER_LANGuage||"ja").includes("ja")?"ja":"en",STAGE_WIDTH=2400,STAGE_HEIGHT=2400,LAYER_MANAGER_LIST=[{name:"layer-basket",target:"Obj_CoopIkuraBankBase"},{name:"layer-gusher",target:"Obj_CoopSpawnGeyser"},{name:"layer-cannon",target:"Obj_MissilePositionVs"},{name:"layer-startpos",target:"StartPos"},{name:"layer-spawner",target:"Obj_CoopSpawnPointZako"},{name:"layer-drizzler-link"},{name:"layer-voronoi",brother:"layer-voronoi-2"},{name:"layer-voronoi-2",isHidden:!0},{name:"layer-drizzler",target:"Obj_CoopJumpPointEnemyRocket"},{name:"layer-flyfish",target:"Obj_CoopArrivalPointEnemyCup"},{name:"layer-stinger",target:"Obj_CoopArrivalPointEnemyTower"},{name:"layer-mothership",target:"Obj_CoopSpawnPointBoss"},{name:"layer-rail",target:"Rail_Pink"},{name:"layer-steelhead",isHidden:!0},{name:"layer-steeleel",isHidden:!0},{name:"layer-item",isHidden:!0}],COLORS=["rgb(233, 30, 99)","rgb(103, 58, 183)","rgb(63, 81, 181)","rgb(3, 169, 244)","rgb(76, 175, 80)","rgb(205, 220, 57)","rgb(255, 236, 60)","rgb(255, 193, 7)","rgb(255, 87, 34)","rgb(121, 85, 72)","rgb(96, 125, 139)","rgb(0, 0, 0)","rgb(150, 150, 150)","rgb(238, 238, 238)","rgb(255, 255, 255)","transparent"],WEAPON={},WEAPON_DEF="\nweapon-0|17||||||shooters\nweapon-10|23||||||shooters\nweapon-20|24||||||shooters\nweapon-30|23||||||shooters\nweapon-40|26||||||shooters\nweapon-50|28||||||shooters\nweapon-60|26||||||shooters\nweapon-70|35||||||shooters\nweapon-80|37||||||shooters\nweapon-90|46||||||shooters\nweapon-200|16|7.14|||||blasters\nweapon-210|21|6.6|||||blasters\nweapon-220|28|7|||||blasters\nweapon-230|19|8|||||blasters\nweapon-240|31|6.6|||||blasters\nweapon-250|36|6.6|||||blasters\nweapon-300|31||||||shooters\nweapon-310|35||||||shooters\nweapon-400|41||26||||shooters\nweapon-1000|10|||6|15|12|rollers\nweapon-1010|16|||9|19|14|rollers\nweapon-1020|22|||10|26|22|rollers\nweapon-1030|16|||6|21|20|rollers\nweapon-1100|16||||||rollers\nweapon-1110|21||||||rollers\nweapon-2000|38||||||chargers\nweapon-2010|52||||||chargers\nweapon-2020|56||||||chargers\nweapon-2030|62||||||chargers\nweapon-2040|66||||||chargers\nweapon-2050|43||||||chargers\nweapon-2060|42||||||chargers\nweapon-3000|31||||||sloshers\nweapon-3010|24||||||sloshers\nweapon-3020|30|3|||||sloshers\nweapon-3030|55||||||sloshers\nweapon-3040|42|6|||||sloshers\nweapon-4000|32||||||splatlings\nweapon-4010|45||||||splatlings\nweapon-4020|52||||||splatlings\nweapon-4030|48||24||||splatlings\nweapon-4040|38||||||splatlings\nweapon-5000|20||||||dualies\nweapon-5010|26||||||dualies\nweapon-5020|35||31||||dualies\nweapon-5030|35||||||dualies\nweapon-5040|29||||||dualies\nweapon-6000|21|||5|||brellas\nweapon-6010|23|||10|||brellas\nweapon-6020|23|||4|||brellas\nweapon-7000|19|7|||||others\nweapon-7010|21|||5|||others\nweapon-7020|62||||||others\nweapon-7030|41|3|||||others\nweapon-8000|48|16|||||others\nweapon-8010|60|16|||||others\nweapon-8020|62|10|||||others\nweapon-8030|28||||||others\nweapon-8040|66||||||others\nweapon-8050|122|18|||||others\n";WEAPON_DEF.split("\n").forEach(e=>{if(!e)return;const t=e.split("|");WEAPON[t[0].trim()]={id:parseInt(t[0].trim().replace("weapon-","")),range:parseFloat(t[1])||-1,blast:parseFloat(t[2])||-1,rangeNear:parseFloat(t[3])||-1,rangeFar:parseFloat(t[4])||-1,vRange:parseFloat(t[5])||-1,vRangeFar:parseFloat(t[6])||-1,kind:t[7]||"others"}});const IMAGE_PIECES=["egg-golden.png","egg-golden-3.png","egg-golden-5.png","egg-golden-10.png","egg-power.png","enemy-app-drizzler.png","enemy-app-flyfish.png","enemy-app-goldie.png","enemy-app-griller.png","enemy-app-maws.png","enemy-app-scrapper.png","enemy-app-steeleel.png","enemy-app-steelhead.png","enemy-app-stinger.png","enemy-chum.png","enemy-drizzler.png","enemy-flyfish.png","enemy-goldie.png","enemy-griller.png","enemy-maws.png","enemy-scrapper.png","enemy-steeleel.png","enemy-steelhead.png","enemy-stinger.png","player-octo-1.png","player-octo-2.png","player-octo-3.png","player-octo-4.png","player-squid-1.png","player-squid-2.png","player-squid-3.png","player-squid-4.png"],LANG={},LANG_DEF="\ntitle|サーモンラン マップビューア|Salmon Run Map Viewer\nstage-selector-title|ステージ|Stage\nshakeup|シェケナダム|Spawning Grounds\nshakeship|難破船ドン･ブラコ|Marooner's Bay\nshakehouse|海上集落シャケト場|Lost Outpost\nshakelift|トキシラズいぶし工房|Salmonid Smokeyard\nshakeride|朽ちた箱舟 ポラリス|Ruins of Ark Polaris\ntide-selector-title|潮位|Tide\nlowtide|干潮|Low Tide\nnormaltide|通常潮|Normal Tide\nhightide|満潮|High Tide\nshort-shakeup|ダム|Grounds\nshort-shakeship|ドンブラコ|Bay\nshort-shakehouse|シャケト場|Outpost\nshort-shakelift|トキシラズ|Yard\nshort-shakeride|ポラリス|Ark\nshort-lowtide|干潮|LT\nshort-normaltide|通常|NT\nshort-hightide|満潮|HT\nmessage-success-copy-share-url|共有URLをコピーしました。|Copied share-URL.\nmessage-success-save-json|上書き保存しました。|Saved.\nmessage-success-save-as-json|保存しました。|Saved.\nmessage-share-error|共有URLにエラーがあります。|There are errors in the share URL.\nmessage-json-error|JSONデータにエラーがあります。|There are errors in the JSON data.\nmessage-no-save-target|保存の対象が見つかりませんでした。|No save target found.\nconfirm-delete|このファイルを削除してもよろしいですか？|Do you want to delete this file?\nconfirm-overwrite|このファイル名はすでに存在します。上書き保存してもいいですか？|This file name already exists. Would you like to overwrite the file?\nmaptype-selector-title|マップの種類|Plan Type\nmaptype-floorplan|平面図|Floor Plan\nmaptype-depthmap|深度図|Depth Map\nmaptype-screenshot|リアル|Screenshot\nobject-adder-title|オブジェクト追加|Add Object\nobject-adder-steeleel|ヘビ|Steel Eel\nobject-adder-steelhead|バクダンサークル|Steelhead Circle\nobject-adder-text|テキスト|Text\nobject-adder-text-initial-value|ダブルクリックで編集|Double Click to Edit\nstage-transformer-title|ステージ変形|Stage Transform\nstage-transformer-x|X|X\nstage-transformer-y|Y|Y\nstage-transformer-scale|拡大率|Scale\nstage-transformer-rotate|回転|Rotate\nstage-transformer-set-default|デフォルト|Set Default\nstage-transformer-no-transform|変形をゼロに|No Transform\ncanvas-transformer-title|キャンバス変形|Canvas Transform\ncanvas-transformer-width|横幅|Width\ncanvas-transformer-height|高さ|Height\ncanvas-transformer-background|背景の色|Background Color\nbutton-copy-to-canvas|キャンバスにコピー|Copy to Canvas\nbutton-clear-canvas|キャンバスをクリア|Clear Canvas\nbutton-download-png|画像をダウンロード|Download PNG\nbutton-download-json|JSONをダウンロード|Download JSON\nbutton-clear-localstorage|ローカルストレージをクリア|Clear Local Storage\nbutton-copy-share-url|共有URLをコピー|Share URL\nbutton-save-json|上書き保存|Save\nbutton-save-as-json|名前を付けて保存|Save As\nbutton-load-json|読み込む|Load\ncancel|キャンセル|Cancel\ndelete|削除|Delete\nautosave|オートセーブファイル|Auto Save File\nweapon-adder-title|ブキ追加|Add Weapon\nimage-adder-title|画像追加|Add Image\ntool-selector-line-width|線の太さ|Line Width\ntool-selector-title|図形ツール|Tools\ntool-selector-select|選択|Select\ntool-selector-pencil|鉛筆|Pencil\ntool-selector-line|直線|Line\ntool-selector-arrow|矢印|Arrow\ntool-selector-polyline|折れ線|Polyline\ntool-selector-rectangle|四角形|Rectangle\ntool-selector-circle|円|Circle\ntool-selector-line-color|線の色|Line Color\ntool-selector-border-color|縁取り色|Border Color\ntool-selector-fill-color|塗りつぶし色|Fill Color\ntool-selector-text-color|文字色|Text Color\ntool-selector-text-border-color|縁取り色|Border Color\nfont-sans-serif|ゴシック体|Sans Serif\nfont-serif|明朝体|Serif\nfont-splatoon1|スプラトゥーン1|Splatoon1\nfont-splatoon2|スプラトゥーン2|Splatoon2\nobject-layer-manager-title|レイヤー|Layer\nlayer-spawner|スポナー|Spawner\nlayer-drawing|図形|Drawing\nlayer-text|テキスト|Text\nlayer-image|画像|Image\nlayer-weapon|ブキ|Weapon\nlayer-steeleel|ヘビ|Steel Eel\nlayer-steelhead|バクダン|Steelhead\nlayer-drizzler-link|コウモリの接続|Drizzler Link\nlayer-voronoi|ボロノイ図|Voronoi\nlayer-drizzler|コウモリ|Drizzler\nlayer-flyfish|カタパッド|Flyfish\nlayer-stinger|タワー|Stinger\nlayer-basket|コンテナ|Basket\nlayer-gusher|カンケツセン|Geyser\nlayer-cannon|大砲|Cannon\nlayer-startpos|スタート地点|Start Pos\nlayer-mothership|ハコビヤ母艦|Mothership\nlayer-rail|ライドレール|Rail\nweapon-0|ボールドマーカー|Sploosh-o-matic\nweapon-10|わかばシューター|Splattershot Jr.\nweapon-20|シャープマーカー|Splash-o-matic\nweapon-30|プロモデラーMG|Aerospray\nweapon-40|スプラシューター|Splattershot\nweapon-50|.52ガロン|.52 Gal\nweapon-60|N-ZAP85|N-ZAP '85\nweapon-70|プライムシューター|Splattershot Pro\nweapon-80|.96ガロン|.96 Gal\nweapon-90|ジェットスイーパー|Jet Squelcher\nweapon-200|ノヴァブラスター|Luna Blaster\nweapon-210|ホットブラスター|Blaster\nweapon-220|ロングブラスター|Range Blaster\nweapon-230|クラッシュブラスター|Clash Blaster\nweapon-240|ラピッドブラスター|Rapid Blaster\nweapon-250|Rブラスターエリート|Rapid Blaster Pro\nweapon-300|L3リールガン|L-3 Nozzlenose\nweapon-310|H3リールガン|H-3 Nozzlenose\nweapon-400|ボトルガイザー|Squeezer\nweapon-1000|カーボンローラー|Carbon Roller\nweapon-1010|スプラローラー|Splat Roller\nweapon-1020|ダイナモローラー|Dynamo Roller\nweapon-1030|ヴァリアブルローラー|Flingza Roller\nweapon-1100|パブロ|Inkbrush\nweapon-1110|ホクサイ|Octobrush\nweapon-2000|スクイックリンα|Squiffer\nweapon-2010|スプラチャージャー|Splat Charger\nweapon-2020|スプラスコープ|Splatterscope\nweapon-2030|リッター4K|E-liter 4K\nweapon-2040|4Kスコープ|E-liter 4K Scope\nweapon-2050|14式竹筒銃・甲|Bamboozler 14\nweapon-2060|ソイチューバー|Goo Tuber\nweapon-3000|バケットスロッシャー|Slosher\nweapon-3010|ヒッセン|Tri-Slosher\nweapon-3020|スクリュースロッシャー|Sloshing Machine\nweapon-3030|オーバーフロッシャー|Bloblobber\nweapon-3040|エクスプロッシャー|Explosher\nweapon-4000|スプラスピナー|Mini Splatling\nweapon-4010|バレルスピナー|Heavy Splatling\nweapon-4020|ハイドラント|Hydra Splatling\nweapon-4030|クーゲルシュライバー|Ballpoint Splatling\nweapon-4040|ノーチラス47|Nautilus 47\nweapon-5000|スパッタリー|Dapple Dualies\nweapon-5010|スプラマニューバー|Splat Dualies\nweapon-5020|ケルビン525|Glooga Dualies\nweapon-5030|デュアルスイーパー|Dualie Squelchers\nweapon-5040|クアッドホッパーブラック|Tetra Dualies\nweapon-6000|パラシェルター|Splat Brella\nweapon-6010|キャンピングシェルター|Tenta Brella\nweapon-6020|スパイガジェット|Undercover Brella\nweapon-7000|クマサン印のブラスター|Grizzco Blaster\nweapon-7010|クマサン印のシェルター|Grizzco Brella\nweapon-7020|クマサン印のチャージャー|Grizzco Charger\nweapon-7030|クマサン印のスロッシャー|Grizzco Slosher\nweapon-8000|スプラッシュボム|Bomb\nweapon-8010|ボムピッチャー|Bomb Launcher\nweapon-8020|ジェットパック|Inkjet\nweapon-8030|スーパーチャクチ|Splashdown\nweapon-8040|ハイパープレッサー|String Ray\nweapon-8050|キャノン|Cannon\nweapon-kind-shooters|シューター|Shooters\nweapon-kind-blasters|ブラスター|Blasters\nweapon-kind-rollers|ローラー|Rollers\nweapon-kind-brushes|フデ|Brushes\nweapon-kind-chargers|チャージャー|Chargers\nweapon-kind-sloshers|スロッシャー|Sloshers\nweapon-kind-splatlings|スピナー|Splatlings\nweapon-kind-dualies|マニューバー|Dualies\nweapon-kind-brellas|シェルター|Brellas\nweapon-kind-others|その他|Others\n";LANG_DEF.split("\n").forEach(e=>{if(!e)return;const t=e.split("|");LANG[t[0].trim()]={ja:t[1].trim(),en:t[2].trim()}});function convert(e,t){return[e+1200,t+1200]}function isTideEqual(e,t){return"low"===e&&"CoopWater_0"===t.layer||"normal"===e&&"CoopWater_1"===t.layer||"high"===e&&"CoopWater_2"===t.layer}function isTideEqualOrMore(e,t){return"low"===e&&("CoopWater_2"===t.layer||"CoopWater_1"===t.layer||"CoopWater_0"===t.layer)||"normal"===e&&("CoopWater_2"===t.layer||"CoopWater_1"===t.layer)||"high"===e&&"CoopWater_2"===t.layer}!function(e){e.fn.myTrigger=function(e){return this.each((t,a)=>{const n=document.createEvent("Event");n.initEvent(e,!1,!0),a.dispatchEvent(n)}),this},e.fn.myOn=function(e,t,a,n){return this.each((o,s)=>{e.split(" ").forEach(e=>{const o={passive:!1,capture:!1};"input"!==e&&"change"!==e||(o.passive=!0),void 0!==a&&(o.passive=a),void 0!==n&&(o.capture=n),e.includes("touch")?s.addEventListener(e,function(e){lastTouchEvent=e,t.call(this,e)},o):s.addEventListener(e,t,o)})}),this},e.fn.elmvar=function(e,t){return void 0!==t?(this.get(0)[e]=t,this):this.get(0)[e]},e.fn.cssvar=function(e,t){return void 0!==t?(this.get(0).style.setProperty(e,t),this):this.get(0).style.getPropertyValue(e)},e.fn.getXY=function(){return{x:parseFloat(this.css("left"))||0,y:parseFloat(this.css("top"))||0}},e.fn.setXY=function(e,t){"object"==typeof e&&(t=e.y,e=e.x);const a=parseFloat(e)+"px",n=parseFloat(t)+"px";return this.css({left:a,top:n}),this},e.fn.setWH=function(e,t){"object"==typeof e&&(t=e.h||e.height,e=e.w||e.width);const a=parseFloat(e)+"px",n=parseFloat(t)+"px";return this.css({width:a,height:n}),this},e.fn.getWH=function(){return{width:parseFloat(this.css("width")),height:parseFloat(this.css("height"))}},e.fn.canvasToStage=function(){const e=this.getWH(),t=parseIntVec(canvasXYToStageXY(this.getXY())),a=this.elmvar("rotate"),n=canvasSetting.stageRotate,o=this.elmvar("myresizableOptions"),s=this.elmvar("mydraggableOptions");if(this.setXY(t),this.elmvar("myRotate")(a-n),o&&"text"===o.elmType){const e=(parseFloat(this.find("textarea").css("font-size"))/canvasSetting.stageScale).toFixed(1);this.find("textarea").css("font-size",`${e}px`),this.find("textarea").myTrigger("input")}else this.setWH({width:parseInt(e.width/canvasSetting.stageScale),height:parseInt(e.height/canvasSetting.stageScale)});return s&&(s.parentType="stage"),o&&o.resize&&o.resize(),this},e.fn.stageToCanvas=function(){const e=this.getWH(),t=parseIntVec(stageXYToCanvasXY(this.getXY())),a=this.elmvar("rotate"),n=canvasSetting.stageRotate,o=this.elmvar("myresizableOptions"),s=this.elmvar("mydraggableOptions");if(this.setXY(t),this.elmvar("myRotate")(a+n),o&&"text"===o.elmType){const e=(parseFloat(this.find("textarea").css("font-size"))*canvasSetting.stageScale).toFixed(1);this.find("textarea").css("font-size",`${e}px`),this.find("textarea").myTrigger("input")}else this.setWH({width:parseInt(e.width/canvasSetting.stageScale),height:parseInt(e.height/canvasSetting.stageScale)});return s&&(s.parentType="canvas"),o&&o.resize&&o.resize(),this},e.checkElementBelowCavnas=function(t,a){const n=pageXYToCanvasXY(getPageXY(t)),o=canvasXYToStageXY(n);let s,r,i=!1;if(a)for(let t=(s=e(".drawing-container")).length-1;t>=0;t--){const e=(r=s.eq(t)).getXY(),a=r.getWH();if(getDistance(e,o)<getDistance({x:a.width,y:a.height})/2){const t=getRotatedVector({x:o.x-e.x,y:o.y-e.y},r.elmvar("rotate")),n={x:parseInt(a.width/2+t.x),y:parseInt(a.height/2+t.y)};if(r.elmvar("mydraggableOptions").ctx.getImageData(n.x,n.y,1,1).data[3]){i=!0;break}}}else for(let t=(s=e("#canvas-container .mydraggable")).length-1;t>=0;t--){let e,a,o,l,c;const g=(r=s.eq(t)).hasClass("range-handle")?3:r.hasClass("myrotatable-handle")?2:r.hasClass("myresizable-handle")?1:0;if(g>0){const t=(c=g>2?r.parent().parent():r.parent()).getXY(),n=c.getWH();if(a={width:30/canvasSetting.stageScale,height:30/canvasSetting.stageScale},o=c.elmvar("rotate"),l=c.elmvar("mydraggableOptions"),1===g)e={x:t.x+n.width/2+a.width/2,y:t.y+n.height/2+a.height/2};else if(2===g)e={x:t.x+n.width/2+a.width/2,y:t.y-n.height/2-a.height/2};else{const a=parseInt(c.cssvar("--range")),n=r.parent().elmvar("rotate"),s=getRotatedVector({x:a,y:0},n);e={x:t.x+s.x,y:t.y+s.y},o+=n}}else e=r.getXY(),a=r.getWH(),o=r.elmvar("rotate"),l=r.elmvar("mydraggableOptions");if("stage"===l.parentType&&(e=stageXYToCanvasXY(e),a=getMultipliedWH(a,canvasSetting.stageScale),o+=canvasSetting.stageRotate),elmRds=getDistance({x:a.width/2,y:a.height/2}),mosRds=getDistance(e,n),mosRds<elmRds){const t=getRotatedVector({x:n.x-e.x,y:n.y-e.y},-o);if(l.ctx){const e=parseInt((t.x+a.width/2)/canvasSetting.stageScale),n=parseInt((t.y+a.height/2)/canvasSetting.stageScale);if(l.ctx.getImageData(e,n,1,1).data[3]){i=!0;break}}else if(-a.width/2<=t.x&&a.width/2>=t.x&&-a.height/2<=t.y&&a.height/2>=t.y){i=!0;break}}}return!!i&&r},e.fn.myDraggable=function(t={}){t=e.extend({parent:"body",parentType:"body",isRemovable:!0},t),this.addClass("mydraggable");const a=e(t.parent),n=a.get(0);if(this.elmvar("mydraggableOptions",t),!n.hasOwnProperty("myDraggableData")){n.myDraggableData={};const e=n.myDraggableData;e.$elm=null,e.startMousePos=null,e.startElmPos=null,a.myOn("mousemove touchmove",t=>{if(e.$elm){const a=e.$elm.elmvar("mydraggableOptions"),n=getPageXY(t);if("canvas"===a.parentType){const t=pageXYToCanvasXY(n.x,n.y),a=e.startElmPos.x+(t.x-e.startMousePos.x),o=e.startElmPos.y+(t.y-e.startMousePos.y);e.$elm.setXY(a,o)}else if("stage"===a.parentType){const t=pageXYToStageXY(n.x,n.y),a=e.startElmPos.x+(t.x-e.startMousePos.x),o=e.startElmPos.y+(t.y-e.startMousePos.y);e.$elm.setXY(a,o)}else{const t=e.startElmPos.x+(n.x-e.startMousePos.x),a=e.startElmPos.y+(n.y-e.startMousePos.y);e.$elm.setXY(t,a)}a.drag&&a.drag(e.$elm.get(0)),t.preventDefault(),t.stopPropagation()}}),a.myOn("mouseup touchend mouseleave touchleave",t=>{if(e.$elm){t.timeStamp,e.mousedownStartTime;if(e.options.isPanel,e.options.isRemovable){let t=e.$elm.getXY();"stage"===e.options.parentType&&(t=stageXYToCanvasXY(t)),0<=t.x&&t.x<=canvasSetting.canvasWidth&&0<=t.y&&t.y<=canvasSetting.canvasHeight||(e.$elm.$family?(e.$elm.$family.remove(),e.$elm.hasClass("stage-object-eel-node")&&updateSteelEelCanvas()):(e.$elm.remove(),e.$elm.hasClass("steelhead")&&updateSteelheadCanvas()))}e.options.isPanel||onChangeCanvas(),e.options.stop&&e.options.stop(e.$elm.get(0)),e.$elm=null}})}const o=n.myDraggableData;return this.onMousedown(a=>{const n=getPageXY(a);if(!a.isForced&&t.startif){const t=e.checkElementBelowCavnas(a,!1),n=document.createEvent("Event");if(n.initEvent("mousedown",!1,!0),n.pageX=a.pageX,n.pageY=a.pageY,n.isForced=!0,t)t.get(0).dispatchEvent(n);else{const t=e(".layer-event.showed");t.length&&t.get(0).dispatchEvent(n)}return void a.stopPropagation()}if(e(this).hasClass("mydraggable-disable"))return;const s=this.getXY();"canvas"===t.parentType?(o.startMousePos=pageXYToCanvasXY(n.x,n.y),o.startElmPos=s):"stage"===t.parentType?(o.startMousePos=pageXYToStageXY(n.x,n.y),o.startElmPos=s):(o.startMousePos=n,o.startElmPos=s),o.$elm=this,o.mousedownTimeStamp=a.timeStamp,o.options=t,t.isPanel||(e(".selected").removeClass("selected"),this.addClass("selected")),o.options.start&&o.options.start(o.$elm.get(0)),a.stopPropagation()}),this},e.fn.myRotatable=function(t={}){t=e.extend({parent:"body",handle:null,isTransformCenter:!1,initialRotate:0},t),this.addClass("myrotatable");const a=t.isTransformCenter?"translate(-50%, -50%) ":"",n=t.handle?t.handle.addClass("myrotatable-handle"):e('<div class="myrotatable-handle"></div>').appendTo(this),o=e(t.parent),s=o.get(0);if(!s.hasOwnProperty("myRotatableData")){s.myRotatableData={};const e=s.myRotatableData;e.$elm=null,o.myOn("mousemove touchmove",t=>{if(e.$elm){const a=getPageXY(t),n=getVectorAngle({x:a.x-e.elmPos.x,y:a.y-e.elmPos.y})-e.startAngle;e.$elm.elmvar("rotate",e.startRotate+n),e.$elm.css("transform",`${e.$elm.elmvar("translateStr")} rotate(${e.$elm.elmvar("rotate")}deg)`),t.preventDefault(),t.stopPropagation()}}),o.myOn("mouseup mouseleave touchend touchleave",t=>{e.$elm&&(e.options.isPanel||onChangeCanvas(),e.$elm=null)})}const r=s.myRotatableData;return this.css("transform-origin","center center").elmvar("translateStr",a).elmvar("myRotate",e=>(this.elmvar("rotate",e).css("transform",`${a} rotate(${e}deg)`),this)).elmvar("myRotate")(t.initialRotate),n.onMousedown(a=>{if(e(this).hasClass("myrotatable-disable"))return;r.$elm=this,r.options=t;const n=getPageXY(a),o=this.get(0).getBoundingClientRect(),s=document.scrollingElement||document.documentElement||document.body,i=s.scrollLeft,l=s.scrollTop,c={x:o.x+o.width/2+i,y:o.y+o.height/2+l},g=getVectorAngle({x:n.x-c.x,y:n.y-c.y});r.startAngle=g,r.elmPos=c,r.startRotate=this.elmvar("rotate"),a.preventDefault(),a.stopPropagation()}),this},e.fn.myResizable=function(t={}){this.addClass("myresizable"),void 0===t.ratio&&(t.ratio=1),this.elmvar("myresizableOptions",t);const a=e('<div class="myresizable-handle"></div>').appendTo(this),n=e(t.parent||"body"),o=n.get(0);if(!o.hasOwnProperty("myResizableData")){o.myResizableData={};const e=o.myResizableData;e.$elm=null,e.startWH=null,e.startFontSize=null,e.startMousePos=null,n.myOn("mousemove touchmove",t=>{if(e.$elm){const a=getDistance(getPageXY(t),e.startElmPos),n=Math.max(24,e.startWH.width*(a/e.startDistance)),o=n*(e.startWH.height/e.startWH.width);if("text"===e.options.elmType){const t=n/e.startWH.width,a=(e.startFontSize*t).toFixed(1);e.$elm.find("textarea").css("font-size",`${a}px`),e.$elm.find("textarea").myTrigger("input")}else e.$elm.setWH(parseInt(n),parseInt(o));e.options.resize&&e.options.resize(e.$elm),t.preventDefault(),t.stopPropagation()}}),n.myOn("mouseup mouseleave touchend touchleave",t=>{e.$elm&&(e.options.isPanel||onChangeCanvas(),e.$elm=null)})}const s=o.myResizableData;return a.onMousedown(a=>{if(e(this).hasClass("myresizable-disable"))return;const n=getPageXY(a),o=getElementsCenterPageXY(this.get(0)),r=getDistance(n,o);s.startMousePos=n,s.startElmPos=o,s.startDistance=r,s.$elm=this,s.startWH=this.getWH(),s.options=t,"text"===s.options.elmType&&(s.startFontSize=parseFloat(this.find("textarea").css("font-size"))),a.preventDefault(),a.stopPropagation()}),this},e.fn.onMousedown=function(e,t){const a={};return this.myOn("mousedown touchstart",t=>{const n=t.timeStamp-a.timeStamp;"mousedown"===t.type&&"touchstart"===a.type&&n<300||(e.call(this,t),a.type=t.type,a.timeStamp=t.timeStamp)},t),this},e.fn.onDoubleClick=function(e){const t={};return this.myOn("mousedown touchstart",a=>{const n=a.timeStamp-t.timeStamp;"mousedown"===a.type&&"touchstart"===t.type&&n<300||(n<500&&e.call(this,a),t.type=a.type,t.timeStamp=a.timeStamp)}),this},e.fn.onLongTouch=function(e){const t={};let a,n,o=!1;return this.myOn("mousedown touchstart",s=>{const r=s.timeStamp-t.timeStamp;"mousedown"===s.type&&"touchstart"===t.type&&r<300||(o=!0,a=setTimeout(()=>{e.call(this,s)},1e3),n=getPageXY(s),t.type=s.type,t.timeStamp=s.timeStamp)}),this.myOn("mousemove touchmove",e=>{if(o){const t=getPageXY(e);Math.abs(t.x-n.x)+Math.abs(t.y-n.y)>10&&(o=!1,clearTimeout(a))}}),this.myOn("mouseleave touchleave",e=>{o=!1,clearTimeout(a)}),this.myOn("mouseup touchend",e=>{o=!1,clearTimeout(a)}),this},e.fn.onShortTouch=function(e){let t,a;return this.onMousedown(e=>{t=getPageXY(e),a=e.timeStamp}),this.myOn("mouseup touchend",n=>{if(t&&a){const o=n.timeStamp-a,s=getPageXY(n);Math.abs(s.x-t.x)+Math.abs(s.y-t.y)<10&&o<100&&e.call(this,n)}}),this},e.fn.setTextBorder=function(e=3,t="white"){let a="";return createShadowPositions(e).forEach((e,n)=>{n>0&&(a+=", "),a+=`${e[0].toFixed(1)}px ${e[1].toFixed(1)}px 0px ${t}`}),this.css("text-shadow",a),this.elmvar("border-width",e),this.elmvar("border-color",t),this},e.fn.setImageBorder=function(e=3,t="white"){let a="";return createShadowPositions(e,4,0).forEach((e,n)=>{n>0&&(a+=" "),a+=`drop-shadow(${e[0].toFixed(1)}px ${e[1].toFixed(1)}px 0px ${t})`}),this.css("filter",a),this.elmvar("border-width",e),this};const t={};e.loadImage=function(e){return new Promise(a=>{if(e in t)a(t[e]);else{const n=new Image;n.onload=(()=>{t[e]=n,a(n)}),n.src=e}})};const a={};e.loadXML=function(t){return new Promise(n=>{t in a?n(a[t]):e.ajax({url:t,type:"GET",dataType:"xml",timeout:1e3,success:function(e){a[t]=e,n(e)}})})}}(jQuery);const objectCreater={Obj_CoopSpawnPointZako_1:(e,t,a,n)=>{if(!isTideEqual(a,e))return null;const[o,s]=convert(e.tx,e.tz);return $('<div class="stage-object spawner spawndir-1"></div>').cssvar("--rotate",`${e.ry}rad`).setXY(o,s)},Obj_CoopSpawnPointZako_2:(e,t,a,n)=>{if(!isTideEqual(a,e))return null;const[o,s]=convert(e.tx,e.tz);return $('<div class="stage-object spawner spawndir-2"></div>').cssvar("--rotate",`${e.ry}rad`).setXY(o,s)},Obj_CoopSpawnPointZako_3:(e,t,a,n)=>{if(!isTideEqual(a,e))return null;const[o,s]=convert(e.tx,e.tz);return $('<div class="stage-object spawner spawndir-3"></div>').cssvar("--rotate",`${e.ry}rad`).setXY(o,s)},Obj_CoopArrivalPointEnemyTower_1:(e,t,a,n)=>{if(!isTideEqual(a,e))return null;const[o,s]=convert(e.tx,e.tz);return $('<div class="stage-object stinger spawndir-1"></div>').cssvar("--rotate",`${e.ry}rad`).setXY(o,s)},Obj_CoopArrivalPointEnemyTower_2:(e,t,a,n)=>{if(!isTideEqual(a,e))return null;const[o,s]=convert(e.tx,e.tz);return $('<div class="stage-object stinger spawndir-2"></div>').cssvar("--rotate",`${e.ry}rad`).setXY(o,s)},Obj_CoopArrivalPointEnemyTower_3:(e,t,a,n)=>{if(!isTideEqual(a,e))return null;const[o,s]=convert(e.tx,e.tz);return $('<div class="stage-object stinger spawndir-3"></div>').cssvar("--rotate",`${e.ry}rad`).setXY(o,s)},Obj_CoopArrivalPointEnemyCup_1:(e,t,a,n)=>{if(!isTideEqual(a,e))return null;const[o,s]=convert(e.tx,e.tz);return $('<div class="stage-object flyfish spawndir-1"></div>').cssvar("--rotate",`${e.ry}rad`).setXY(o,s)},Obj_CoopArrivalPointEnemyCup_2:(e,t,a,n)=>{if(!isTideEqual(a,e))return null;const[o,s]=convert(e.tx,e.tz);return $('<div class="stage-object flyfish spawndir-2"></div>').cssvar("--rotate",`${e.ry}rad`).setXY(o,s)},Obj_CoopArrivalPointEnemyCup_3:(e,t,a,n)=>{if(!isTideEqual(a,e))return null;const[o,s]=convert(e.tx,e.tz);return $('<div class="stage-object flyfish spawndir-3"></div>').cssvar("--rotate",`${e.ry}rad`).setXY(o,s)},Obj_CoopJumpPointEnemyRocket:(e,t,a,n)=>{if(!isTideEqual(a,e))return null;const[o,s]=convert(e.tx,e.tz),r=$('<div class="drizzler-container"><input type="checkbox" id="'+e.id+'"><label class="stage-object drizzler" for="'+e.id+'"></label><div></div></div>');return r.find("label").css({left:`${o}px`,top:`${s}px`}),r.find("div").css({left:`${o}px`,top:`${s}px`}),r},Obj_CoopIkuraBankBase:(e,t,a,n)=>{if(!isTideEqualOrMore(a,e))return null;const[o,s]=convert(e.tx,e.tz);return $('<img class="stage-object basket" src="./assets/img/stage-object/mapicon-'+n+'-basket.png">').cssvar("--rotate",`${-e.ry}deg`).setXY(o,s)},Obj_CoopSpawnGeyser:(e,t,a,n)=>{if(!isTideEqualOrMore(a,e))return null;const[o,s]=convert(e.tx,e.tz);return $('<img class="stage-object gusher" src="./assets/img/stage-object/mapicon-'+n+'-gusher.png">').setXY(o,s)},Obj_MissilePositionVs:(e,t,a,n)=>{if(!isTideEqualOrMore(a,e))return null;const[o,s]=convert(e.tx,e.tz);return $('<img class="stage-object cannon" src="./assets/img/stage-object/mapicon-'+n+'-cannon.png">').setXY(o,s)},StartPos:(e,t,a,n)=>{const[o,s]=convert(e.tx,e.tz);return $('<div class="stage-object startpos">'+(parseInt(e.index)+1)+"</div>").setXY(o,s)},Obj_CoopSpawnPointBoss:(e,t,a,n)=>{if(!isTideEqual(a,e))return null;const[o,s]=convert(e.tx,e.tz);return $('<div class="stage-object mothership"></div>').cssvar("--rotate",`${e.ry}rad`).setXY(o,s)},Rail_Pink:(e,t,a,n)=>{if("shakeride"!==t||"high"===a&&"CoopWater_2"!==e.layer||"normal"===a&&"CoopWater_1"!==e.layer&&"CoopWater_2"!==e.layer||"low"===a&&"CoopWater_0"!==e.layer)return null;const[o,s]=convert(e.tx,e.tz);let r=!0,i=$("#canvas-rail");i.size()<1&&(r=!1,(i=$('<canvas id="canvas-rail"></canvas>')).get(0).width=STAGE_WIDTH,i.get(0).height=STAGE_HEIGHT);const l=i.get(0).getContext("2d");if("CoopWater_0"===e.layer?(l.fillStyle="#ff4383",l.strokeStyle="#ff4383"):"CoopWater_1"===e.layer?(l.fillStyle="orange",l.strokeStyle="orange"):"CoopWater_2"===e.layer&&(l.fillStyle="blue",l.strokeStyle="blue"),l.save(),l.translate(o,s),l.rotate(-e.ry*Math.PI/180),l.beginPath(),l.arc(0,0,6,0,360*Math.PI/180,!1),l.fill(),l.restore(),e.controls){l.lineWidth=4,l.beginPath(),l.moveTo(o,s);for(let t=1;t<e.controls.length;t++){const a=e.controls[t-1],n=e.controls[t],[o,s]=convert(a.c2x,a.c2z),[r,i]=convert(n.c1x,n.c1z),[c,g]=convert(n.tx,n.tz);l.bezierCurveTo(o,s,r,i,c,g)}l.stroke()}return r?null:i}},BORDER_WIDTH_MIN=2;function getXYWH(e,t,a,n){const o=a-e,s=n-t;return{minX:e,minY:t,x:e+o/2,y:t+s/2,width:o,height:s,radius:getDistance({x:o,y:s})/2}}function isOpaque(e,t,a){const n=pageXYToCanvasXY(e.pageX,e.pageY),o=t.getXY(),s=t.getWH(),r=(o.x,s.width,o.y,s.height,getRotatedVector({x:n.x-o.x,y:n.y-o.y},-t.elmvar("rotate"))),i=parseInt(r.x+s.width/2),l=parseInt(r.y+s.height/2);return!!a.getImageData(i,l,1,1).data[3]}function determineDrawingCommon(e){(e=$.extend({x:0,y:0,minX:0,minY:0,width:100,height:100,radius:null,initialWidth:null,params:null,initialRotate:0,toolType:"pencil",isJSON:!1},e)).initialWidth||(e.initialWidth=e.width),"toolSetting"in e.params||(e.params.toolSetting=$.extend({},toolSetting));const t=canvasTools[e.toolType].update,[a,n]=createCanvas(e.width,e.height);$.extend(n,e.params);const o=$('<div class="drawing-container"></div>');o.append(a).attr("item-type","drawing").addClass("added-item").elmvar("options",e).elmvar("ctx",n).setWH(e.width,e.height).setXY(e.x,e.y).myDraggable({ctx:n,startif:e=>isOpaque(e,o,n)}).myOn("mousemove",e=>{$.checkElementBelowCavnas(e,!1)?o.css("cursor","move"):o.css("cursor","default")}).myResizable({resize:()=>{const s=o.getWH();a.width=s.width,a.height=s.height,t(n,e.minX,e.minY,s.width/e.initialWidth)}}).myRotatable({initialRotate:e.initialRotate,isTransformCenter:!0}).appendTo("#layer-item"),e.isJSON?(t(n,e.minX,e.minY,e.width/e.initialWidth),o.elmvar("mydraggableOptions").parentType="stage"):o.canvasToStage(),tempDrawingCtx.clear(),onChangeCanvas()}const canvasTools={pencil:{update:function(e,t=0,a=0,n=1){const o=e.toolSetting;e.clear(),e.lineJoin="round",e.lineCap="round",e.beginPath(),e.verticesList.forEach(o=>{o.forEach((o,s)=>{e[0===s?"moveTo":"lineTo"](n*(o.x-t),n*(o.y-a))})}),o.borderColor&&"transparent"!==o.borderColor&&(e.lineWidth=o.lineWidth*n+Math.max(2,o.borderWidth*n),e.strokeStyle=o.borderColor,e.stroke()),o.fillColor&&"transparent"!==o.fillColor&&(e.fillStyle=o.fillColor,e.fill()),o.lineColor&&"transparent"!==o.lineColor&&(e.lineWidth=o.lineWidth*n,e.strokeStyle=o.lineColor,e.stroke())},init:function(e){const t=this;let a=!1,n=!1,o=[],s=[];function r(){if(!o.length)return;let e=-1/0,t=-1/0,a=1/0,n=1/0;o.forEach(o=>{o.forEach((o,s)=>{o.x>e&&(e=o.x),o.x<a&&(a=o.x),o.y>t&&(t=o.y),o.y<n&&(n=o.y)})});const s=toolSetting.lineWidth;a-=s,n-=s,e+=s,t+=s;o.forEach((e,t)=>{if(e.length>2){const a=[];e.forEach((t,n)=>{if(n<=1)a.push(t);else{const o=e[n-2],s=e[n-1],r=t;dx1=Math.sign(s.x-o.x),dy1=Math.sign(s.y-o.y),dx2=Math.sign(r.x-s.x),dy2=Math.sign(r.y-s.y),0===dx1&&0===dx2&&dy1===dy2?(a[a.length-1].x=t.x,a[a.length-1].y=t.y):0===dy1&&0===dy2&&dx1===dx2?(a[a.length-1].x=t.x,a[a.length-1].y=t.y):a.push(t)}}),o[t]=a}}),determineDrawingCommon($.extend(getXYWH(a,n,e,t),{params:{verticesList:o},toolType:"pencil"})),o=[]}e.onMousedown(e=>{a=!0;const n=parseIntVec(pageXYToCanvasXY(getPageXY(e)));s=[n],o.push(s),tempDrawingCtx.verticesList=o,t.update(tempDrawingCtx)}),$("body").myOn("mousemove touchmove",e=>{if(a){n=!0;const a=parseIntVec(pageXYToCanvasXY(getPageXY(e)));s.push(a),t.update(tempDrawingCtx)}else if("pencil"===currentTool&&o.length){const t=parseIntVec(pageXYToCanvasXY(getPageXY(e)));0<=t.x&&t.x<=canvasSetting.canvasWidth&&0<=t.y&&t.y<=canvasSetting.canvasHeight||r()}}),$("body").myOn("mouseup touchend mouseleave touchleave",e=>{n=!1,a=!1}),this.isDown=(()=>a),this.determineDrawing=r}},circle:{update:function(e,t=0,a=0,n=1){const o=e.toolSetting;e.clear(),e.lineJoin="round",e.lineCap="round",e.beginPath(),e.arc(n*(e.centerPos.x-t),n*(e.centerPos.y-a),n*e.radius,0,2*Math.PI,!1),o.borderColor&&"transparent"!==o.borderColor&&(e.lineWidth=o.lineWidth*n+Math.max(2,o.borderWidth*n),e.strokeStyle=o.borderColor,e.stroke()),o.fillColor&&"transparent"!==o.fillColor&&(e.fillStyle=o.fillColor,e.fill()),o.lineColor&&"transparent"!==o.lineColor&&(e.lineWidth=o.lineWidth*n,e.strokeStyle=o.lineColor,e.stroke())},init:function(e){const t=this;let a,n,o=!1,s=!1;e.onMousedown(e=>{o=!0,a=parseIntVec(pageXYToCanvasXY(getPageXY(e)))}),$("body").myOn("mousemove touchmove",e=>{if(o){s=!0;const o=parseIntVec(pageXYToCanvasXY(getPageXY(e)));n=Math.max(5,Math.max(Math.abs(o.x-a.x),Math.abs(o.y-a.y))),tempDrawingCtx.centerPos=a,tempDrawingCtx.radius=n,t.update(tempDrawingCtx)}}),$("body").myOn("mouseup mouseleave touchend touchleave",e=>{s&&function(e,t){const a=e.x-t-toolSetting.lineWidth,n=e.y-t-toolSetting.lineWidth,o=e.x+t+toolSetting.lineWidth,s=e.y+t+toolSetting.lineWidth;determineDrawingCommon($.extend(getXYWH(a,n,o,s),{params:{centerPos:e,radius:t},toolType:"circle"}))}(a,n),o=!1,s=!1})}},rectangle:{update:function(e,t=0,a=0,n=1){const o=e.toolSetting;e.clear(),e.lineJoin="round",e.lineCap="round";const s=n*(Math.min(e.ltPos.x,e.rbPos.x)-t),r=n*(Math.min(e.ltPos.y,e.rbPos.y)-a),i=n*(Math.max(e.ltPos.x,e.rbPos.x)-t),l=n*(Math.max(e.ltPos.y,e.rbPos.y)-a);o.borderColor&&"transparent"!==o.borderColor&&(e.lineWidth=o.lineWidth*n+Math.max(2,o.borderWidth*n),e.strokeStyle=o.borderColor,e.strokeRect(s,r,i-s,l-r)),o.fillColor&&"transparent"!==o.fillColor&&(e.fillStyle=o.fillColor,e.fillRect(s,r,i-s,l-r)),o.lineColor&&"transparent"!==o.lineColor&&(e.lineWidth=o.lineWidth*n,e.strokeStyle=o.lineColor,e.strokeRect(s,r,i-s,l-r))},init:function(e){const t=this;let a,n,o=!1,s=!1;e.onMousedown(e=>{o=!0,a=parseIntVec(pageXYToCanvasXY(getPageXY(e)))}),$("body").myOn("mousemove touchmove",e=>{o&&(s=!0,n=parseIntVec(pageXYToCanvasXY(getPageXY(e))),tempDrawingCtx.ltPos=a,tempDrawingCtx.rbPos=n,t.update(tempDrawingCtx))}),$("body").myOn("mouseup mouseleave touchend touchleave",e=>{s&&function(e,t){const a=Math.min(e.x,t.x)-toolSetting.lineWidth,n=Math.min(e.y,t.y)-toolSetting.lineWidth,o=Math.max(e.x,t.x)+toolSetting.lineWidth,s=Math.max(e.y,t.y)+toolSetting.lineWidth;determineDrawingCommon($.extend(getXYWH(a,n,o,s),{params:{ltPos:e,rbPos:t},toolType:"rectangle"}))}(a,n),o=!1,s=!1})}},line:{update:function(e,t=0,a=0,n=1){const o=e.toolSetting;e.clear(),e.lineJoin="round",e.lineCap="round";Math.min(e.pos1.x,e.pos2.x),Math.min(e.pos1.y,e.pos2.y),Math.max(e.pos1.x,e.pos2.x),Math.max(e.pos1.y,e.pos2.y);o.borderColor&&"transparent"!==o.borderColor&&(e.lineWidth=o.lineWidth*n+Math.max(2,o.borderWidth*n),e.strokeStyle=o.borderColor,e.beginPath(),e.moveTo(n*(e.pos1.x-t),n*(e.pos1.y-a)),e.lineTo(n*(e.pos2.x-t),n*(e.pos2.y-a)),e.stroke()),o.lineColor&&"transparent"!==o.lineColor&&(e.lineWidth=o.lineWidth*n,e.strokeStyle=o.lineColor,e.beginPath(),e.moveTo(n*(e.pos1.x-t),n*(e.pos1.y-a)),e.lineTo(n*(e.pos2.x-t),n*(e.pos2.y-a)),e.stroke())},init:function(e){const t=this;let a,n,o=!1,s=!1;e.onMousedown(e=>{o=!0,a=parseIntVec(pageXYToCanvasXY(getPageXY(e)))}),$("body").myOn("mousemove touchmove",e=>{o&&(s=!0,n=parseIntVec(pageXYToCanvasXY(getPageXY(e))),tempDrawingCtx.pos1=a,tempDrawingCtx.pos2=n,t.update(tempDrawingCtx))}),$("body").myOn("mouseup mouseleave touchend touchleave",e=>{s&&function(e,t){const a=Math.min(e.x,t.x)-toolSetting.lineWidth,n=Math.min(e.y,t.y)-toolSetting.lineWidth,o=Math.max(e.x,t.x)+toolSetting.lineWidth,s=Math.max(e.y,t.y)+toolSetting.lineWidth;determineDrawingCommon($.extend(getXYWH(a,n,o,s),{params:{pos1:e,pos2:t},toolType:"line"}))}(a,n),o=!1,s=!1})}},arrow:{update:function(e,t=0,a=0,n=1){const o=e.toolSetting;e.clear(),e.lineJoin="round",e.lineCap="round",e.lineWidth=o.borderWidth,e.strokeStyle=o.borderColor,e.fillStyle=o.lineColor,e.beginPath();const s=n*o.lineWidth/2;e.arrow(n*(e.pos1.x-t),n*(e.pos1.y-a),n*(e.pos2.x-t),n*(e.pos2.y-a),[0,-s,6*-s,-s,6*-s,3*-s]),e.stroke(),e.fill()},init:function(e){const t=this;let a,n,o=!1,s=!1;e.onMousedown(e=>{o=!0,a=parseIntVec(pageXYToCanvasXY(getPageXY(e)))}),$("body").myOn("mousemove touchmove",e=>{o&&(s=!0,n=parseIntVec(pageXYToCanvasXY(getPageXY(e))),tempDrawingCtx.pos1=a,tempDrawingCtx.pos2=n,t.update(tempDrawingCtx))}),$("body").myOn("mouseup mouseleave touchend touchleave",e=>{s&&function(e,t){const a=Math.min(e.x,t.x)-toolSetting.lineWidth,n=Math.min(e.y,t.y)-toolSetting.lineWidth,o=Math.max(e.x,t.x)+toolSetting.lineWidth,s=Math.max(e.y,t.y)+toolSetting.lineWidth;determineDrawingCommon($.extend(getXYWH(a,n,o,s),{params:{pos1:e,pos2:t},toolType:"arrow"}))}(a,n),o=!1,s=!1})}},polyline:{update:function(e,t=0,a=0,n=1){const o=e.toolSetting;e.clear(),e.lineJoin="round",e.lineCap="round",e.beginPath(),e.path.forEach((o,s)=>{e[0===s?"moveTo":"lineTo"](n*(o.x-t),n*(o.y-a))}),o.borderColor&&"transparent"!==o.borderColor&&(e.lineWidth=o.lineWidth*n+Math.max(2,o.borderWidth*n),e.strokeStyle=o.borderColor,e.stroke()),o.fillColor&&"transparent"!==o.fillColor&&(e.fillStyle=o.fillColor,e.fill()),o.lineColor&&"transparent"!==o.lineColor&&(e.lineWidth=o.lineWidth*n,e.strokeStyle=o.lineColor,e.stroke())},init:function(e){const t=this;let a=!1,n=!1,o=[];let s=null;e.onMousedown(e=>{a=!0;const t=s?e.timeStamp-s:1/0;s=e.timeStamp;const r=parseIntVec(pageXYToCanvasXY(getPageXY(e)));(o.length>=2?getDistance(o[o.length-2],r):1/0)<20&&t<300?(!function(){let e=-1/0,t=-1/0,a=1/0,n=1/0;o.forEach((o,s)=>{o.x>e&&(e=o.x),o.x<a&&(a=o.x),o.y>t&&(t=o.y),o.y<n&&(n=o.y)});const s=toolSetting.lineWidth;a-=s,n-=s,e+=s,t+=s,determineDrawingCommon($.extend(getXYWH(a,n,e,t),{params:{path:o},toolType:"polyline"}))}(),o=[],a=!1,n=!1,s=null,e.stopPropagation()):(o.length||o.push(r),o[o.length]={x:r.x,y:r.y})}),$("body").myOn("mousemove touchmove",e=>{if(a){n=!0;const a=parseIntVec(pageXYToCanvasXY(getPageXY(e))),s=o[o.length-1];s.x=a.x,s.y=a.y,tempDrawingCtx.path=o,t.update(tempDrawingCtx)}}),$("body").myOn("mouseup mouseleave touchend touchleave",e=>{n=!1})}}};function readJSON(e){console.log("loading json..."),console.log(e),isEnabledAutosave=!1;const t={maptype:e.cs.mt,stage:e.cs.st,tide:e.cs.td,canvasColor:e.cs.cc,canvasWidth:e.cs.cw,canvasHeight:e.cs.ch,stageX:e.cs.sx,stageY:e.cs.sy,stageScale:e.cs.ss,stageRotate:e.cs.sr};$.extend(canvasSetting,t),$("#radio-"+t.stage).prop("checked",!0),$("#radio-"+t.tide).prop("checked",!0),$("#radio-"+t.maptype).prop("checked",!0);for(let t in e.ol)$(`#checkbox-layer-${t}`).each((a,n)=>{$(n).prop("checked",Boolean(e.ol[t])).myTrigger("change")});t.onloadxml=(()=>{e.dz&&e.dz.forEach(e=>{$("#"+e).prop("checked",!0)}),e.vt&&drawVoronoi(e.vt),setTimeout(()=>{isEnabledAutosave=!0},100)}),loadStage(t),e.se&&e.se.forEach(e=>{addSteelEel({nodePositions:e})}),e.sh&&e.sh.forEach(e=>{addSteelheadCircle({x:e.x,y:e.y,type:e.t})}),e.il&&e.il.forEach(e=>{switch(e.tp){case"w":addWeapon({id:e.id,x:e.x,y:e.y,width:e.w,height:e.h,initialVisibleRange:e.rv,initialRotate:e.r,initialRotateRange:e.rr});break;case"i":addImage({src:e.src,x:e.x,y:e.y,width:e.w,height:e.h,initialRotate:e.r});break;case"t":addTextarea({text:e.t,x:e.x,y:e.y,fontSize:e.s,initialRotate:e.r,textColor:e.c,borderColor:e.b,fontFamily:e.f});break;case"d":if(e.pm.verticesList){const t=[];e.pm.verticesList.forEach(e=>{const a=[],n=[];let o,s,r="";for(let t=0;t<e.length;t++){const n=e[t];if(!!n.match(/[0-9\.\-]/))r+=n;else{if(r){const e=parseInt(r);a.push(e),r=""}if(","!==n){const e=alphabetToNumber(n);a.push(e)}}}for(let e=0;e<a.length;e+=2){const t=a[e+0],r=a[e+1];let i,l;0===e?(i=t,l=r):(i=o+t,l=s+r),o=i,s=l,n.push({x:i,y:l})}t.push(n)}),e.pm.verticesList=t}e.pm.ts&&(e.pm.toolSetting={lineWidth:e.pm.ts.lw,lineColor:e.pm.ts.lc,borderWidth:e.pm.ts.bw,borderColor:e.pm.ts.bc,fillColor:e.pm.ts.fc}),determineDrawingCommon({params:e.pm,x:e.x,y:e.y,width:e.w,height:e.h,initialRotate:e.r,minX:e.mx,minY:e.my,initialWidth:e.iw,toolType:e.tt,isJSON:!0})}})}function htmlToJSON(){const e={},t=canvasSetting;e.cs={mt:t.maptype,st:t.stage,td:t.tide,cc:t.canvasColor,cw:t.canvasWidth,ch:t.canvasHeight,sx:t.stageX,sy:t.stageY,ss:t.stageScale,sr:t.stageRotate};const a={};$("#object-layer-manager input").each((e,t)=>{const n=$(t).attr("id").replace("checkbox-layer-",""),o=$(t).prop("checked")?1:0;a[n]=o}),e.ol=a;const n=[];$("#layer-drizzler .drizzler-container").each((e,t)=>{const a=$(t).find("input").attr("id");$(t).find("input").prop("checked")&&n.push(a)}),n.length&&(e.dz=n);const o=$voronoiCanvas.attr("voronoi-target");o&&(e.vt=o);const s=[];$("#layer-steeleel .stage-object.eel").each((e,t)=>{const a=[];$(t).find(".stage-object-eel-node").each((e,t)=>{const n=$(t).getXY(),o=$(t).elmvar("rotate");a.push({x:parseInt(n.x),y:parseInt(n.y),r:parseInt(o)})}),s.push(a)}),s.length&&(e.se=s);const r=[];$("#layer-steelhead .steelhead").each((e,t)=>{const a=$(t).getXY(),n=parseInt($(t).attr("data-type"));r.push({x:parseInt(a.x),y:parseInt(a.y),t:n})}),r.length&&(e.sh=r);const i=[];return $("#layer-item").find(".added-item").each((e,t)=>{switch($(t).attr("item-type")){case"weapon":{const e=$(t),a=parseInt(e.attr("data-weapon-id")),n=e.getXY(),o=e.getWH(),s=e.elmvar("rotate"),r=e.find(".range-container"),l="none"!==r.css("display")?1:0,c=r.elmvar("rotate"),g={tp:"w",id:a,x:n.x,y:n.y,w:o.width,h:o.height,r:s,rv:l,rr:c};i.push(g);break}case"image":{const e=$(t),a=e.find("img").attr("src"),n=(parseInt(e.attr("data-weapon-id")),e.getXY()),o=e.getWH(),s=e.elmvar("rotate"),r={tp:"i",src:a,x:n.x,y:n.y,w:o.width,h:o.height,r:s};i.push(r);break}case"text":{const e=$(t),a=e.find("textarea"),n=a.val(),o=e.getXY(),s=a.elmvar("options"),r=parseFloat(a.css("font-size")),l=parseInt(e.elmvar("rotate")),c={tp:"t",t:n,x:parseInt(o.x),y:parseInt(o.y),s:r,r:l,f:s.fontFamily,c:s.textColor,b:s.borderColor};i.push(c);break}case"drawing":{const e=$(t),a=$.extend(!0,{},e.elmvar("options")),n=a.params,o=e.elmvar("rotate"),s=e.getXY(),r=e.getWH();if("pencil"===a.toolType){const e=[];n.verticesList.forEach(t=>{let a,n,o,s="";t.forEach((e,t)=>{if(0===t)s+=e.x+","+e.y,o=e.y;else{const t=e.x-a,r=e.y-n,i=-25<=r&&r<=26,l=-25<=t&&t<=26?numberToAlphabet(t):t,c=i?numberToAlphabet(r):r;"number"==typeof o&&"number"==typeof l&&(s+=","),s+=l,"number"==typeof(o=l)&&"number"==typeof c&&(s+=","),s+=c,o=c}a=e.x,n=e.y}),e.push(s)}),n.verticesList=e}n.toolSetting&&(n.ts={lw:n.toolSetting.lineWidth,lc:n.toolSetting.lineColor,bw:n.toolSetting.borderWidth,bc:n.toolSetting.borderColor,fc:n.toolSetting.fillColor},delete n.toolSetting);const l={tp:"d",x:s.x,y:s.y,w:r.width,h:r.height,r:o,pm:n,mx:a.minX,my:a.minY,iw:a.initialWidth,tt:a.toolType};i.push(l);break}}}),i.length&&(e.il=i),e}function htmlToCanvas(){$canvasContainer.get(0).getBoundingClientRect();const e=canvasSetting,t=$('<canvas id="view-canvas"></canvas>');t.get(0).width=e.canvasWidth,t.get(0).height=e.canvasHeight;const a=t.get(0).getContext("2d");return"transparent"!==canvasSetting.canvasColor&&(a.fillStyle=canvasSetting.canvasColor,a.fillRect(0,0,e.canvasWidth,e.canvasHeight)),a.save(),a.translate(e.canvasWidth/2+e.stageX,e.canvasHeight/2+e.stageY),a.rotate(e.stageRotate*Math.PI/180),a.drawImage($("#stage-image").get(0),-1200*e.stageScale,-1200*e.stageScale,2400*e.stageScale,2400*e.stageScale),a.restore(),$(".layer-object").each((t,n)=>{const o=$(n).attr("id");if("block"===$(n).css("display"))switch(o){case"layer-startpos":a.textAlign="center",a.textBaseline="middle",$(n).find("div").each((t,n)=>{const o=$(n).text(),s=$(n).getXY(),r=stageXYToCanvasXY(s.x,s.y),i=window.getComputedStyle(n);a.fillStyle=i.color,a.font=`${i.fontWeight} ${(parseInt(i.fontSize)*e.stageScale).toFixed(1)}px ${i.fontFamily}`,a.fillText(o,r.x,r.y)});break;case"layer-basket":case"layer-gusher":case"layer-cannon":$(n).find("img").each((t,n)=>{const o=$(n).getXY(),s=stageXYToCanvasXY(o.x,o.y),r=parseFloat($(n).cssvar("--rotate")),i=31*e.stageScale,l=31*e.stageScale;a.save(),a.translate(s.x,s.y),a.rotate((e.stageRotate+r)*Math.PI/180),a.drawImageCenter(n,0,0,i,l),a.restore()});break;case"layer-rail":$("#canvas-rail").length&&(a.save(),a.translate(e.canvasWidth/2+e.stageX,e.canvasHeight/2+e.stageY),a.rotate(e.stageRotate*Math.PI/180),a.drawImage($("#canvas-rail").get(0),-1200*e.stageScale,-1200*e.stageScale,2400*e.stageScale,2400*e.stageScale),a.restore());break;case"layer-drizzler-link":a.save(),a.translate(e.canvasWidth/2+e.stageX,e.canvasHeight/2+e.stageY),a.rotate(e.stageRotate*Math.PI/180),a.drawImage($("#canvas-drizzler-link").get(0),-1200*e.stageScale,-1200*e.stageScale,2400*e.stageScale,2400*e.stageScale),a.restore();break;case"layer-voronoi":a.save(),"floorplan"===canvasSetting.maptype?(a.globalCompositeOperation="multiply",a.globalAlpha=.8):(a.globalCompositeOperation="overlay",a.globalAlpha=0),a.translate(e.canvasWidth/2+e.stageX,e.canvasHeight/2+e.stageY),a.rotate(e.stageRotate*Math.PI/180),a.drawImage($("#canvas-voronoi").get(0),-1200*e.stageScale,-1200*e.stageScale,2400*e.stageScale,2400*e.stageScale),a.restore();break;case"layer-voronoi-2":"floorplan"!==canvasSetting.maptype&&(a.save(),a.translate(e.canvasWidth/2+e.stageX,e.canvasHeight/2+e.stageY),a.rotate(e.stageRotate*Math.PI/180),a.drawImage($("#canvas-voronoi-2").get(0),-1200*e.stageScale,-1200*e.stageScale,2400*e.stageScale,2400*e.stageScale),a.restore());break;case"layer-steeleel":a.save(),a.translate(e.canvasWidth/2+e.stageX,e.canvasHeight/2+e.stageY),a.rotate(e.stageRotate*Math.PI/180),a.drawImage($("#canvas-steeleel").get(0),-1200*e.stageScale,-1200*e.stageScale,2400*e.stageScale,2400*e.stageScale),a.restore(),a.shadowBlur=4,a.shadowColor="rgba(0, 0, 0, 0.4)",a.shadowOffsetX=2,a.shadowOffsetY=2,$(n).find("img").each((t,n)=>{const o=$(n).getXY(),s=stageXYToCanvasXY(o.x,o.y),r=parseFloat($(n).cssvar("--rotate")),i=e.stageScale*n.naturalWidth*.08,l=e.stageScale*n.naturalHeight*.08;a.save(),a.translate(s.x,s.y),a.rotate((e.stageRotate+r)*Math.PI/180),a.drawImageCenter(n,0,0,i,l),a.restore()}),a.shadowBlur=0,a.shadowColor="rgba(0, 0, 0, 0)";break;case"layer-steelhead":case"layer-drizzler":case"layer-flyfish":case"layer-stinger":"layer-steelhead"===o&&(a.save(),a.translate(e.canvasWidth/2+e.stageX,e.canvasHeight/2+e.stageY),a.rotate(e.stageRotate*Math.PI/180),a.drawImage($("#canvas-steelhead").get(0),-1200*e.stageScale,-1200*e.stageScale,2400*e.stageScale,2400*e.stageScale),a.restore()),"layer-drizzler"===o&&(a.lineCap="round",a.lineJoin="round",a.shadowColor="rgba(0, 0, 0, 0)",a.shadowOffsetX=0,a.shadowOffsetY=0,a.lineWidth=0,$(n).find("label").each((t,n)=>{if($("#"+$(n).attr("for")).prop("checked")){const t=$(n).next().get(0),o=window.getComputedStyle(t),s=stageXYToCanvasXY(parseFloat(o.left),parseFloat(o.top)),r=e.stageScale*parseFloat(o.width)/2;a.fillStyle=o.backgroundColor,a.fillCircle(s.x,s.y,r)}})),a.lineCap="round",a.lineJoin="round",a.shadowColor="rgba(0, 0, 0, 0.2)",a.shadowOffsetX=4*e.stageScale,a.shadowOffsetY=4*e.stageScale,a.lineWidth=8*e.stageScale,$(n).find("layer-drizzler"===o?"label":"div").each((t,n)=>{const o=window.getComputedStyle(n),s=e.stageScale*parseFloat(o.width)/2,r=stageXYToCanvasXY(parseFloat(o.left),parseFloat(o.top));a.fillStyle=o.backgroundColor,a.strokeStyle=o.borderColor,a.beginPath(),a.arc(r.x,r.y,s,0,2*Math.PI,!1),a.shadowBlur=6,a.shadowColor="rgba(0, 0, 0, 0.2)",a.stroke(),a.shadowBlur=0,a.shadowColor="rgba(0, 0, 0, 0)",a.fill()}),a.shadowBlur=0,a.shadowColor="rgba(0, 0, 0, 0)";break;case"layer-mothership":case"layer-spawner":a.lineCap="round",a.lineJoin="round",a.shadowColor="rgba(0, 0, 0, 0.2)",a.shadowBlur=6,a.shadowOffsetX=4*e.stageScale,a.shadowOffsetY=4*e.stageScale,a.lineWidth=8*e.stageScale,$(n).find("div").each((t,n)=>{const o=window.getComputedStyle(n),s=e.stageScale*parseFloat(o.width),r=stageXYToCanvasXY(parseFloat(o.left),parseFloat(o.top));a.fillStyle=o.backgroundColor,a.strokeStyle=o.borderColor,a.shadowBlur=6,a.shadowColor="rgba(0, 0, 0, 0.2)",a.strokeRect(r.x-s/2,r.y-s/2,s,s),a.shadowBlur=0,a.shadowColor="rgba(0, 0, 0, 0)",a.fillRect(r.x-s/2,r.y-s/2,s,s)}),a.shadowBlur=0,a.shadowColor="rgba(0, 0, 0, 0)";break;case"layer-item":$(n).find(".added-item").each((e,t)=>{switch($(t).attr("item-type")){case"weapon":{const e=$(t),n=e.find("img").get(0),o=stageXYToCanvasXY(e.getXY()),s=e.getWH(),r=e.elmvar("rotate"),i=e.find("img").elmvar("border-width");if("none"!==e.find(".range-container").css("display")){const t=r+e.find(".range-container").elmvar("rotate"),n=canvasSetting.stageScale*parseFloat(e.cssvar("--range")),s=canvasSetting.stageScale*parseFloat(e.cssvar("--blast")),i=canvasSetting.stageScale*parseFloat(e.cssvar("--range-near")),l=canvasSetting.stageScale*parseFloat(e.cssvar("--range-far")),c=canvasSetting.stageScale*parseFloat(e.cssvar("--v-range")),g=canvasSetting.stageScale*parseFloat(e.cssvar("--v-range-far")),d=c<0?0:-10,p=12;a.save(),a.translate(o.x,o.y),a.rotate((canvasSetting.stageRotate+t)*Math.PI/180),e.find(".range-line").each((e,t)=>{a.fillStyle="#ff2ea5",a.fillRect(0,-1*canvasSetting.stageScale+d,n,2*canvasSetting.stageScale)}),e.find(".range-end").each((e,t)=>{if(a.fillStyle="#ff2ea5",c<0)a.fillCircle(n,d,8*canvasSetting.stageScale);else{const e=15,t=30,o=5;a.fillRoundRect(n-e/2,d-t/2,e,t,o)}}),e.find(".range-blast").each((e,t)=>{a.fillStyle="rgba(255, 46, 165, .4)",a.fillCircle(n,d,s/2)}),e.find(".range-far").each((e,t)=>{a.fillStyle="rgba(255, 46, 165, .4)";const o=l,s=c>0?30:15;a.fillRoundRect(n,d-s/2,o,s,5)}),e.find(".range-near-end").each((e,t)=>{a.fillStyle="#ff2ea5",a.fillCircle(i,d,5)}),e.find(".v-range-line").each((e,t)=>{a.fillStyle="#ff2ea5",a.fillRect(0,-1+p,c,2)}),e.find(".v-range-end").each((e,t)=>{a.fillStyle="#ff2ea5",a.fillCircle(c,p,8)}),e.find(".v-range-far").each((e,t)=>{a.fillStyle="rgba(255, 46, 165, .4)";const n=g;a.fillRoundRect(c,p-7.5,n,15,5)}),a.restore()}a.save(),a.translate(o.x,o.y),a.rotate((canvasSetting.stageRotate+r)*Math.PI/180),a.drawImageCenterBorder(n,0,0,canvasSetting.stageScale*s.width,canvasSetting.stageScale*s.height,i,"white"),a.restore();break}case"image":{const e=$(t),n=e.find("img").get(0),o=stageXYToCanvasXY(e.getXY()),s=e.getWH(),r=e.elmvar("rotate"),i=e.find("img").elmvar("border-width");a.save(),a.translate(o.x,o.y),a.rotate((canvasSetting.stageRotate+r)*Math.PI/180),a.drawImageCenterBorder(n,0,0,canvasSetting.stageScale*s.width,canvasSetting.stageScale*s.height,i,"white"),a.restore();break}case"drawing":{const e=$(t),n=e.find("canvas").get(0),o=stageXYToCanvasXY(e.getXY()),s=e.getWH(),r=e.elmvar("rotate");a.save(),a.translate(o.x,o.y),a.rotate((canvasSetting.stageRotate+r)*Math.PI/180),a.drawImageCenter(n,0,0,canvasSetting.stageScale*s.width,canvasSetting.stageScale*s.height),a.restore();break}case"text":{const e=$(t),n=($("body"),e.find("textarea"));let o=n.getWH().width,s=n.getWH().height;const r=e.getXY(),i=stageXYToCanvasXY(r),l=canvasSetting.stageScale;let c=r.x,g=r.y,d=t.rotate;d+=canvasSetting.stageRotate,c=i.x,g=i.y,o*=l;const p=n.elmvar("border-width")*l,h=n.elmvar("border-color"),m=$("<p>"+n.val()+"</p>"),v=window.getComputedStyle(n.get(0));m.css({margin:"0",padding:"0",position:"fixed",left:"-100%",top:"-100%","word-break":"break-all","white-space":"nowrap","line-height":v.lineHeight,"letter-spacing":v.letterSpacing,"font-size":v.fontSize,"font-family":v.fontFamily,"font-weight":v.fontWeight}).appendTo("body");const u=m.height();m.remove(),a.save(),a.translate(c,g),a.rotate(d*Math.PI/180);const y=l*parseFloat(v.fontSize),f=n.val().split("\n");a.fillStyle=v.color,a.font=`${v.fontWeight} ${y}px ${v.fontFamily}`,a.textAlign="left",a.textBaseline="middle",a.strokeStyle=h||"white",a.lineWidth=2.5*p,a.lineJoin="round",["strokeText","fillText"].forEach(e=>{let t=u/2;f.forEach(n=>{a[e](n,0-o/2,t-s/2),t+=u})}),a.restore();break}}})}}),t.get(0)}let stageObjects,drizzlerObjects,$canvasContainer,$stageContainer,$tempDrawingCanvas,tempDrawingCtx,$ymapCanvas,ymapCtx,$steeleelCanvas,steeleelCtx,$steelheadCanvas,steelheadCtx,$drizzlerLinkCanvas,drizzlerLinkCtx,$voronoiCanvas,voronoiCtx,$voronoiCanvas2,voronoiCtx2,ymapImagedata,voronoi,lastTouchEvent,autosaveTimerId,ymapReady=!1,ymapReadyFuncs=[],stageObjectsReady=!1,stageObjectsReadyFuncs=[],html2canvasWorking=!1,currentFilename="",canvasSetting={stage:"shakeup",tide:"normal",maptype:"depthmap",stageX:0,stageY:0,stageScale:1,stageRotate:0,canvasWidth:800,canvasHeight:800,seaHeight:75,canvasColor:"rgb(255, 255, 255)"},toolSetting={lineWidth:10,lineColor:"rgb(0, 0, 0)",borderWidth:4,borderColor:"rgb(255, 255, 255)",fillColor:"transparent"},textSetting={fontFamily:"sans-serif",textColor:"rgb(0, 0, 0)",borderColor:"rgb(255, 255, 255)"},isEnabledAutosave=!0,currentTool="select";function init(){$(".hidden-in-production").remove(),WebFont.load({custom:{families:["Splatoon1","Splatoon2"]},active:function(){$(".textarea-container textarea").myTrigger("input")}}),document.title=getLang("title"),$canvasContainer=$("#canvas-container").css({width:`${canvasSetting.canvasWidth}px`,height:`${canvasSetting.canvasHeight}px`}),$stageContainer=$("#stage-container").css({left:`${canvasSetting.canvasWidth/2}px`,top:`${canvasSetting.canvasHeight/2}px`,width:`${STAGE_WIDTH}px`,height:`${STAGE_HEIGHT}px`,transformOrigin:"center"}),$("body").onMousedown(e=>{$(".selected").removeClass("selected")});const e=$("#weapon-adder"),t=[];for(let a in WEAPON){const n=WEAPON[a].id,o=WEAPON[a].kind,s=getLang(a);if(!t.includes(o)){t.push(o);const a=getLang(`weapon-kind-${o}`);e.append(`<h5>${a}</h5><div id="weapon-adder-${o}"></div>`)}const r=$(`<img src="./assets/img/weapon/${n}.png">`);r.attr("title",s),r.onMousedown(e=>{e.preventDefault(),addWeapon({id:n})}),$(`#weapon-adder-${o}`).append(r)}const a=$("#image-adder");for(let e=0;e<IMAGE_PIECES.length;e++){const t=IMAGE_PIECES[e],n=$(`<img src="./assets/img/piece/${t}">`);n.onMousedown(e=>{e.preventDefault(),addImage({src:"./assets/img/piece/"+t})}),a.append(n)}const n=localStorage.getItem(STORAGE_KEY),o=n?JSON.parse(n):DEFAULT_SAVEDATAOBJ,s=$("#object-layer-manager .selector-container");LAYER_MANAGER_LIST.forEach((e,t)=>{const a=$('<div class="layer-object" id="'+e.name+'"></div>').css({width:`${STAGE_WIDTH}px`,height:`${STAGE_HEIGHT}px`}).appendTo($stageContainer);if("layer-voronoi-2"===e.name&&(o["checkbox-layer-voronoi"]||a.hide()),e.isHidden)return;const n=$('<label draggable="false" id="label-checkbox-'+e.name+'" for="checkbox-'+e.name+'"></label>'),r=$('<input type="checkbox" id="checkbox-'+e.name+'">'),i=$('<div class="object-layer-name"></div>');o["checkbox-"+e.name]&&r.prop("checked",!0),n.append(r),n.append(i),s.prepend(n),i.text(getLang(e.name)),r.myOn("change",t=>{const n=r.prop("checked");if(n?a.show():a.hide(),e.brother){const t=$("#"+e.brother);n?t.show():t.hide()}saveStorage(),onChangeCanvas()}),o["checkbox-"+e.name]?a.show():a.hide(),n.myOn("mousedown",e=>{e.stopPropagation()})});{const[e,t]=createCanvas(STAGE_WIDTH,STAGE_HEIGHT),a=$(e).attr("id","canvas-steelhead").appendTo("#layer-steelhead");$steelheadCanvas=a,steelheadCtx=t}{const[e,t]=createCanvas(STAGE_WIDTH,STAGE_HEIGHT),a=$(e).attr("id","canvas-steeleel").appendTo("#layer-steeleel");$steeleelCanvas=a,steeleelCtx=t}{const[e,t]=createCanvas(STAGE_WIDTH,STAGE_HEIGHT),a=$(e).attr("id","canvas-drizzler-link").appendTo("#layer-drizzler-link");$drizzlerLinkCanvas=a,drizzlerLinkCtx=t}{voronoi=new Voronoi;const[e,t]=createCanvas(STAGE_WIDTH,STAGE_HEIGHT),a=$(e).attr("id","canvas-voronoi").appendTo("#layer-voronoi");$voronoiCanvas=a,voronoiCtx=t}{const[e,t]=createCanvas(STAGE_WIDTH,STAGE_HEIGHT),a=$(e).attr("id","canvas-voronoi-2").appendTo("#layer-voronoi-2");$voronoiCanvas2=a,voronoiCtx2=t}$("label,input[type=range]").each((e,t)=>{$(t).onMousedown(e=>{e.stopPropagation()},!0)});{const[e,t]=createCanvas(canvasSetting.canvasWidth,canvasSetting.canvasHeight),a=$(e).attr("id","canvas-tempdrawing").appendTo($canvasContainer);t.lineWidth=10,t.lineJoin="round",t.lineCap="round",t.strokeStyle="black",t.toolSetting=toolSetting,$tempDrawingCanvas=a,tempDrawingCtx=t}{const e="select",t=getLang(`tool-selector-${e}`);$(`<label for="radio-tool-${e}"><input type="radio" name="tool" value="${e}" id="radio-tool-${e}" checked="checked"><div class="stage-selector-name">${t}</div></label>`).appendTo("#tool-selector .selector-container")}for(let e in canvasTools){const t=getLang(`tool-selector-${e}`),a=($(`<label for="radio-tool-${e}"><input type="radio" name="tool" value="${e}" id="radio-tool-${e}"><div class="stage-selector-name">${t}</div></label>`).appendTo("#tool-selector .selector-container"),$('<div class="layer-event" id="layer-event-'+e+'"></div>').appendTo($canvasContainer));canvasTools[e].init.call(canvasTools[e],a)}$("input[type=radio][name=tool]").myOn("change",e=>{const t=$("input[type=radio][name=tool]:checked").val();$(".layer-event").each((e,t)=>$(t).removeClass("showed")),currentTool=t,"select"!==t&&$("#layer-event-"+t).addClass("showed"),canvasTools.pencil.isDown()||canvasTools.pencil.determineDrawing()}),$stageContainer.css({left:`${canvasSetting.canvasWidth/2}px`,top:`${canvasSetting.canvasHeiht/2}px`,transformOrigin:"center",transform:"translate(-50%, -50%)"}),["stage-rotate","stage-scale","stage-x","stage-y"].forEach(e=>{const t=$(`#input-range-${e}`),a=$(`#input-text-${e}`);function n(e){const t=canvasSetting,a=canvasXYToStageXY(t.canvasWidth/2,t.canvasHeight/2);if(t.stageX=parseInt($("#input-range-stage-x").val()),t.stageY=parseInt($("#input-range-stage-y").val()),t.stageRotate=parseInt($("#input-range-stage-rotate").val()),t.stageScale=parseFloat($("#input-range-stage-scale").val()),$("html").cssvar("--stage-scale",`${t.stageScale}`),$("html").cssvar("--stage-rotate",`${t.stageRotate}deg`),e.includes("scale")||e.includes("rotate")){const e=stageXYToCanvasXY(a.x,a.y),n=t.canvasWidth/2-e.x,o=t.canvasHeight/2-e.y;t.stageX=Math.round(t.stageX+n),t.stageY=Math.round(t.stageY+o),$("#input-range-stage-x,#input-text-stage-x").val(t.stageX),$("#input-range-stage-y,#input-text-stage-y").val(t.stageY)}$stageContainer.css({left:`${t.canvasWidth/2+t.stageX}px`,top:`${t.canvasHeight/2+t.stageY}px`,transformOrigin:"center center",transform:`translate(-50%, -50%) rotate(${t.stageRotate}deg) scale(${t.stageScale})`})}t.myOn("input",e=>{const o=t.attr("id"),s=t.val();a.val(s),n(o)}),a.myOn("input",e=>{const o=t.attr("id"),s=a.val();t.val(s),n(o)}),a.onMousedown(e=>{e.preventDefault(),e.stopPropagation(),a.focus()})}),["canvas-width","canvas-height"].forEach(e=>{const t=$(`#input-range-${e}`),a=$(`#input-text-${e}`);function n(){canvasSetting.canvasWidth=parseInt($("#input-range-canvas-width").val()),canvasSetting.canvasHeight=parseInt($("#input-range-canvas-height").val()),$tempDrawingCanvas.get(0).width=canvasSetting.canvasWidth,$tempDrawingCanvas.get(0).height=canvasSetting.canvasHeight,$canvasContainer.css({width:`${canvasSetting.canvasWidth}px`,height:`${canvasSetting.canvasHeight}px`}),$stageContainer.css({left:`${canvasSetting.canvasWidth/2+canvasSetting.stageX}px`,top:`${canvasSetting.canvasHeight/2+canvasSetting.stageY}px`})}t.myOn("input",e=>{const o=t.val();a.val(o),n()}),a.myOn("input",e=>{const o=a.val();t.val(o),n()}),a.onMousedown(e=>{e.preventDefault(),e.stopPropagation(),a.focus()})});{const e=$("#input-range-line-width"),t=$("#input-text-line-width");e.myOn("input",a=>{const n=parseInt(e.val());t.val(n),toolSetting.lineWidth=n}),t.myOn("input",a=>{const n=parseInt(t.val());e.val(n),toolSetting.lineWidth=n}),e.val(toolSetting.lineWidth),t.val(toolSetting.lineWidth)}$("#stage-selector input[name=stage],#stage-selector input[name=tide]").myOn("change",()=>{selectStage(),saveStorage()}),$("#stage-selector input[name=maptype]").myOn("change",()=>{canvasSetting.maptype=$("input[type=radio][name=maptype]:checked").val()||"depthmap",$("#stage-image").attr("src",`./assets/img/stage/${canvasSetting.maptype}/${canvasSetting.stage}-${canvasSetting.tide}.png`),$("#layer-basket img").each((e,t)=>{$(t).attr("src",`./assets/img/stage-object/mapicon-${canvasSetting.maptype}-basket.png`)}),$("#layer-gusher img").each((e,t)=>{$(t).attr("src",`./assets/img/stage-object/mapicon-${canvasSetting.maptype}-gusher.png`)}),$("#layer-cannon img").each((e,t)=>{$(t).attr("src",`./assets/img/stage-object/mapicon-${canvasSetting.maptype}-cannon.png`)}),$canvasContainer.removeClass("depthmap"),$canvasContainer.removeClass("screenshot"),$canvasContainer.removeClass("floorplan"),$canvasContainer.addClass(canvasSetting.maptype),updateVoronoi(),saveStorage()});{const[e,t]=createCanvas(STAGE_WIDTH,STAGE_HEIGHT),a=$(e);$ymapCanvas=a,ymapCtx=t}$(".translate").each((e,t)=>{const a=getLang($(t).attr("langkey"));$(t).text(a)}),$(".version-text").text(VERSION),$(".draggable-panel").each((e,t)=>{$(t).myDraggable({isPanel:!0,isRemovable:!1})}),RangeTouch.setup("[type=range]"),$("#input-text-canvas-color").val("rgb(255, 255, 255)").paletteColorPicker({colors:COLORS,custom_class:"double",insert:"after",clear_btn:null,timeout:2e3,onchange_callback:setCanvasColor}).hide(),[["drawing-line-color","lineColor"],["drawing-border-color","borderColor"],["drawing-fill-color","fillColor"],["text-color","textColor"],["text-border-color","borderColor"]].forEach(e=>{const t=e[0].includes("text")?textSetting:toolSetting;$("#input-text-"+e[0]).val(t[e[1]]).paletteColorPicker({colors:COLORS,custom_class:"double",insert:"after",clear_btn:null,timeout:2e3,onchange_callback:a=>{t[e[1]]=a,"transparent"===a?$("[data-target="+e[0]+"]").addClass("transparent"):$("[data-target="+e[0]+"]").removeClass("transparent")}}).hide(),"transparent"===t[e[1]]&&$("[data-target="+e[0]+"]").addClass("transparent")}),$("#font-setting").myOn("change",function(e){const t=$(this).val();textSetting.fontFamily=t});$canvasContainer.elmvar("scale",1),$canvasContainer.css("transform-origin","left top"),$canvasContainer.css("transform","scale(canvasScale)"),$("body").myOn("dragenter",e=>{e.preventDefault()}),$("body").myOn("dragover",e=>{e.preventDefault()}),$("body").myOn("drop",e=>{const t=e.dataTransfer.files[0];if(!t||!t.type)return;if("application/json"!==t.type&&"text/plain"!==t.type)return;const a=new FileReader;a.onload=function(e){try{readJSON(JSON.parse(e.target.result))}catch(e){console.error(e),alert(getLang("message-json-error"))}},a.readAsText(t),e.preventDefault(),e.stopPropagation()}),$("#stage-transformer-set-default").onMousedown(e=>{const t=DEFAULT_MAP_TRANSFORM[`${canvasSetting.stage}-${canvasSetting.tide}`]||[0,0,.34,0,75];canvasSetting.stageX=t[0],canvasSetting.stageY=t[1],canvasSetting.stageScale=t[2],canvasSetting.stageRotate=t[3],canvasSetting.seaHeight=t[4],$("#input-range-stage-x,#input-text-stage-x").val(canvasSetting.stageX),$("#input-range-stage-y,#input-text-stage-y").val(canvasSetting.stageY),$("#input-range-stage-rotate,#input-text-stage-rotate").val(canvasSetting.stageRotate),$("#input-range-stage-scale,#input-text-stage-scale").val(canvasSetting.stageScale),$("html").cssvar("--stage-scale",`${canvasSetting.stageScale}`),$("html").cssvar("--stage-rotate",`${canvasSetting.stageRotate}deg`),$stageContainer.css({left:`${canvasSetting.canvasWidth/2+canvasSetting.stageX}px`,top:`${canvasSetting.canvasHeight/2+canvasSetting.stageY}px`,transformOrigin:"center center",transform:`translate(-50%, -50%) rotate(${canvasSetting.stageRotate}deg) scale(${canvasSetting.stageScale})`})}),$("#stage-transformer-no-transform").onMousedown(e=>{canvasSetting.stageX=0,canvasSetting.stageY=0,canvasSetting.stageScale=1,canvasSetting.stageRotate=0,$("#input-range-stage-x,#input-text-stage-x").val(canvasSetting.stageX),$("#input-range-stage-y,#input-text-stage-y").val(canvasSetting.stageY),$("#input-range-stage-rotate,#input-text-stage-rotate").val(canvasSetting.stageRotate),$("#input-range-stage-scale,#input-text-stage-scale").val(canvasSetting.stageScale),$("html").cssvar("--stage-scale",`${canvasSetting.stageScale}`),$("html").cssvar("--stage-rotate",`${canvasSetting.stageRotate}deg`),$stageContainer.css({left:`${canvasSetting.canvasWidth/2+canvasSetting.stageX}px`,top:`${canvasSetting.canvasHeight/2+canvasSetting.stageY}px`,transformOrigin:"center center",transform:`translate(-50%, -50%) rotate(${canvasSetting.stageRotate}deg) scale(${canvasSetting.stageScale})`})});const r=window.innerWidth||document.body.clientWidth||document.documentElement.clientWidth||1280;$("#object-layer-manager").css("left",r-340+"px"),$("#object-adder").css("left",r-340+"px"),$("#weapon-adder").css("left",r-340+"px")}function clearLocalStorage(){localStorage.removeItem(STORAGE_KEY),localStorage.removeItem(STORAGE_KEY_AUTOSAVE),localStorage.removeItem(STORAGE_KEY_JSONSAVE)}function saveStorage(){const e={};$("#object-layer-manager input[type=checkbox]").each((t,a)=>{const n=$(a).attr("id"),o=$(a).prop("checked");e[n]=o}),e.stage=$("input[type=radio][name=stage]:checked").val()||"shakeup",e.tide=$("input[type=radio][name=tide]:checked").val()||"normal",e.maptype=$("input[type=radio][name=maptype]:checked").val()||"depthmap";const t=JSON.stringify(e);localStorage.setItem(STORAGE_KEY,t)}function loadStorage(){const e=localStorage.getItem(STORAGE_KEY),t=e?JSON.parse(e):DEFAULT_SAVEDATAOBJ;$("#radio-"+t.stage).prop("checked",!0),$("#radio-"+t.tide).prop("checked",!0),$("#radio-"+t.maptype).prop("checked",!0),$canvasContainer.addClass(t.maptype)}function getLang(e){return LANG[e]?LANG[e][USER_LANG]:"null"}function readXML(e){function t(e,t){const a=e.querySelector(t);return a?a.getAttribute("StringValue"):""}const a=e.documentElement.querySelectorAll("Root>C1>C0>C1"),n=[],o=[],s=[],r={};Array.prototype.forEach.call(a,(e,a)=>{const i=t(e,"[Name=Id]"),l=t(e,"[Name=LayerConfigName]"),c=function(e,t){const a=e.querySelectorAll(t);return a[a.length-1].getAttribute("StringValue")}(e,"[Name=UnitConfigName]"),g=t(e,"[Name=InTeamIndex]"),d=parseFloat(t(e,"[Name=Translate]>[Name=X]")),p=parseFloat(t(e,"[Name=Translate]>[Name=Y]")),h=parseFloat(t(e,"[Name=Translate]>[Name=Z]")),m=parseFloat(t(e,"[Name=Scale]>[Name=X]")),v=parseFloat(t(e,"[Name=Scale]>[Name=Y]")),u=parseFloat(t(e,"[Name=Scale]>[Name=Z]")),y=parseFloat(t(e,"[Name=Rotate]>[Name=X]")),f=parseFloat(t(e,"[Name=Rotate]>[Name=Y]")),S=parseFloat(t(e,"[Name=Rotate]>[Name=Z]")),x=function(e){const t=e.querySelector("[Name=Links]");if(t&&t.querySelector("[Name=LinkBuf]")){const e=t.querySelectorAll("C1");if(e.length){const t=[];return Array.prototype.forEach.call(e,e=>{const a=e.querySelector("[Name=DestUnitId]");if(a){const e=a.getAttribute("StringValue");t.push(e)}}),t}}return null}(e);o.includes(l)||o.push(l),s.includes(c)?r[c]++:(s.push(c),r[c]=1);const w={id:i,num:r[c],index:g,layer:l,group:c,tx:d,ty:p,tz:h,sx:m,sy:v,sz:u,rx:y,ry:f,rz:S,links:x};if("Rail_Pink"===c){const a=[],n=e.querySelectorAll("[Name=RailPoints]>C1");Array.prototype.forEach.call(n,e=>{const n=parseFloat(t(e,"[Name=Translate]>[Name=X]")),o=parseFloat(t(e,"[Name=Translate]>[Name=Y]")),s=parseFloat(t(e,"[Name=Translate]>[Name=Z]")),r=parseFloat(t(e,"[Name=ControlPoints]>C1:nth-child(1)>[Name=X]")),i=parseFloat(t(e,"[Name=ControlPoints]>C1:nth-child(1)>[Name=Y]")),l=parseFloat(t(e,"[Name=ControlPoints]>C1:nth-child(1)>[Name=Z]")),c=parseFloat(t(e,"[Name=ControlPoints]>C1:nth-child(2)>[Name=X]")),g=parseFloat(t(e,"[Name=ControlPoints]>C1:nth-child(2)>[Name=Y]")),d=parseFloat(t(e,"[Name=ControlPoints]>C1:nth-child(2)>[Name=Z]"));a.push({tx:n,ty:o,tz:s,c1x:r,c1y:i,c1z:l,c2x:c,c2y:g,c2z:d})}),w.controls=a}n.push(w)}),stageObjects=n,drizzlerObjects=filterStageObjects("Obj_CoopJumpPointEnemyRocket"),LAYER_MANAGER_LIST.forEach(e=>{if(!e.target)return;const t=$("#"+e.name);n.forEach(a=>{if(a.group.includes(e.target)){const e=objectCreater[a.group](a,canvasSetting.stage,canvasSetting.tide,canvasSetting.maptype);e&&(e.attr("title",`${a.id}`),t.append(e))}})}),updateDrizzlerLinkCanvas(),stageObjectsReady=!0,stageObjectsReadyFuncs.length&&(stageObjectsReadyFuncs.forEach(e=>{e()}),stageObjectsReadyFuncs=[])}function updateDrizzlerLinkCanvas(){drizzlerObjects.forEach(e=>{const t=drizzlerLinkCtx;isTideEqual(canvasSetting.tide,e)&&e.links&&e.links.forEach(a=>{const n=getDrizzlerObject(a);t.lineCap="round",t.beginPath(),t.moveTo(e.tx+1200,e.tz+1200),t.lineTo(n.tx+1200,n.tz+1200),t.strokeStyle="white",t.lineWidth=3,t.stroke()})}),drizzlerObjects.forEach(e=>{const t=drizzlerLinkCtx;isTideEqual(canvasSetting.tide,e)&&e.links&&e.links.forEach(a=>{const n=getDrizzlerObject(a);t.lineCap="round",t.beginPath(),t.moveTo(e.tx+1200,e.tz+1200),t.lineTo(n.tx+1200,n.tz+1200),t.strokeStyle="#2196f3",t.lineWidth=3,t.stroke()})}),$("#layer-drizzler .stage-object.drizzler").each((e,t)=>{$(t).get(0).onclick=(e=>{e.preventDefault()}),$(t).onShortTouch(e=>{const a=$(t).attr("for"),n=$("#"+a),o=n.prop("checked");n.prop("checked",!o)}),$(t).onLongTouch(e=>{$("#checkbox-layer-voronoi").prop("checked",!0).myTrigger("change"),drawVoronoi($(t).attr("for"))})})}function updateVoronoi(){const e=$voronoiCanvas.attr("voronoi-target");e&&drawVoronoi(e)}function drawVoronoi(e){let t=voronoiCtx;$voronoiCanvas.attr("voronoi-target",e);const a=getDrizzlerObject(e),n=[];drizzlerObjects.forEach(t=>{isTideEqual(canvasSetting.tide,t)&&t.links&&t.links.includes(e)&&!n.includes(t.id)&&n.push(t.id)}),a.links&&a.links.forEach(e=>{n.includes(e)||n.push(e)});const o=[];if(n.forEach(e=>{const t=getDrizzlerObject(e);o.push({x:t.tx+1200,y:t.tz+1200})}),o.length){const e=voronoi.compute(o,{xl:0,xr:STAGE_WIDTH,yt:0,yb:STAGE_HEIGHT});if(voronoiCtx.clear(),voronoiCtx2.clear(),"floorplan"===canvasSetting.maptype){var s,r,l=[],c=e.cells.length;for(s=0;s<c;s++){var g=[],d=e.cells[s],p=d.halfedges.length;for(r=0;r<p;r++){var h=d.halfedges[r].edge.va,m=d.halfedges[r].edge.vb,v=0==r?d.halfedges[r+1].edge.va:d.halfedges[r-1].edge.va,u=0==r?d.halfedges[r+1].edge.vb:d.halfedges[r-1].edge.vb,y=0==r?h==v||h==u?m:h:h==v||h==u?h:m,f={};f.x=y.x,f.y=y.y,g.push(f)}l.push(g)}l.forEach((e,a)=>{t.fillStyle=["#E1FA49","#DB934F","#F263EB","#4F84DB","#5CFF7B","#E1FA49","#DB934F","#F263EB"][a],t.beginPath(),e.forEach((e,a)=>{t[0===a?"moveTo":"lineTo"](e.x,e.y)}),t.closePath(),t.fill()})}if("floorplan"!==canvasSetting.maptype){(t=voronoiCtx2).strokeStyle="white",t.lineWidth=2/canvasSetting.stageScale;var S=e.edges.length;for(i=0;i<S;i++){h=e.edges[i].va,m=e.edges[i].vb;t.beginPath(),t.moveTo(h.x,h.y),t.lineTo(m.x,m.y),t.stroke()}}}}function filterStageObjects(e,t){const a=[];return stageObjects.forEach(n=>{e&&!n.group.includes(e)||t&&!n.layer.includes(t)||a.push(n)}),a}function getDrizzlerObject(e){for(let t=0;t<drizzlerObjects.length;t++)if(drizzlerObjects[t].id===e)return drizzlerObjects[t];return null}function selectStage(){canvasSetting.stage=$("input[type=radio][name=stage]:checked").val()||"shakeup",canvasSetting.tide=$("input[type=radio][name=tide]:checked").val()||"normal",canvasSetting.maptype=$("input[type=radio][name=maptype]:checked").val()||"depthmap",loadStage({stage:canvasSetting.stage,tide:canvasSetting.tide,maptype:canvasSetting.maptype})}function onChangeCanvas(){clearTimeout(autosaveTimerId),isEnabledAutosave&&(autosaveTimerId=setTimeout(autosave,AUTOSAVE_INTERVAL))}function autosave(){const e=htmlToJSON(),t=JSON.stringify(e),a=(getDateStr(),getLang("short-"+canvasSetting.stage),getLang("short-"+canvasSetting.tide+"tide"),htmlToCanvas()),[n,o]=createCanvas(60,60);o.drawImage(a,0,0,60,60);const s={json:t,thumb:n.toDataURL("image/jpeg",.5),version:VERSION,timestamp:(new Date).getTime()};localStorage.setItem(STORAGE_KEY_AUTOSAVE,JSON.stringify(s)),console.log("%cauto-saved.","color: cyan;")}function clearCanvas(){$("#layer-item").empty(),$("#layer-steeleel .stage-object,#layer-steelhead .stage-object").remove(),steelheadCtx.clear(),steeleelCtx.clear()}function clearStage(){$(".drizzler-container").remove(),$(".stage-object").remove(),$("#canvas-rail").remove(),tempDrawingCtx.clear(),drizzlerLinkCtx.clear(),$voronoiCanvas.removeAttr("voronoi-target"),voronoiCtx.clear(),voronoiCtx2.clear(),clearCanvas(),$stageContainer.css({left:`${canvasSetting.canvasWidth/2}px`,top:`${canvasSetting.canvasHeight/2}px`,transformOrigin:"center",transform:"translate(-50%, -50%)"})}function loadStage(e){$("#stage-name").text(getLang(e.stage)),$("#tide-name").text(getLang(e.tide+"tide")),clearStage(),ymapReady=!1,$.loadImage(`./assets/img/stage/ymap/${e.stage}.png`).then(e=>{ymapCtx.drawImage(e,0,0,STAGE_WIDTH,STAGE_HEIGHT),ymapImagedata=ymapCtx.getImageData(0,0,STAGE_WIDTH,STAGE_HEIGHT),ymapReady=!0,ymapReadyFuncs.length&&(ymapReadyFuncs.forEach(e=>{e()}),ymapReadyFuncs=[])}),"shakeride"===e.stage?$("label[for=checkbox-layer-rail]").show():$("label[for=checkbox-layer-rail]").hide(),stageObjectsReady=!1,$.loadXML(`./assets/xml/${e.stage}.xml`).then(t=>{readXML(t),e.onloadxml&&e.onloadxml()}),$("#stage-image").attr("src",`./assets/img/stage/${e.maptype}/${e.stage}-${e.tide}.png`).css("display","block");const t=DEFAULT_MAP_TRANSFORM[`${e.stage}-${e.tide}`]||[0,0,.34,0,75];canvasSetting.stageX=void 0!==e.stageX?e.stageX:t[0],canvasSetting.stageY=void 0!==e.stageY?e.stageY:t[1],canvasSetting.stageScale=void 0!==e.stageScale?e.stageScale:t[2],canvasSetting.stageRotate=void 0!==e.stageRotate?e.stageRotate:t[3],canvasSetting.seaHeight=void 0!==e.seaHeight?e.seaHeight:t[4],$("#input-range-stage-x,#input-text-stage-x").val(canvasSetting.stageX),$("#input-range-stage-y,#input-text-stage-y").val(canvasSetting.stageY),$("#input-range-stage-rotate,#input-text-stage-rotate").val(canvasSetting.stageRotate),$("#input-range-stage-scale,#input-text-stage-scale").val(canvasSetting.stageScale),$("html").cssvar("--stage-scale",`${canvasSetting.stageScale}`),$("html").cssvar("--stage-rotate",`${canvasSetting.stageRotate}deg`),$stageContainer.css({left:`${canvasSetting.canvasWidth/2+canvasSetting.stageX}px`,top:`${canvasSetting.canvasHeight/2+canvasSetting.stageY}px`,transformOrigin:"center center",transform:`translate(-50%, -50%) rotate(${canvasSetting.stageRotate}deg) scale(${canvasSetting.stageScale})`}),void 0!==e.canvasWidth&&(canvasSetting.canvasWidth=e.canvasWidth,canvasSetting.canvasHeight=e.canvasHeight,$("#input-range-canvas-width,#input-text-canvas-width").val(canvasSetting.canvasWidth),$("#input-range-canvas-height,#input-text-canvas-height").val(canvasSetting.canvasHeight).myTrigger("input")),e.canvasColor&&($("#input-text-canvas-color").val(e.canvasColor.replace("transparent","")),setCanvasColor(e.canvasColor))}function setCanvasColor(e){$canvasContainer.css("background",e),canvasSetting.canvasColor=e,"transparent"===e?$("[data-target=canvas-color]").addClass("transparent"):$("[data-target=canvas-color]").removeClass("transparent")}function readShareURL(){const e=getQueries();if(e.hasOwnProperty("json"))try{return readJSON(JSON.parse(decodeURIComponent(e.json))),!0}catch(e){console.error(e),alert(getLang("message-share-error"))}return!1}function closeLoadJSON(){$("#load").hide()}function loadJSON(){let e=localStorage.getItem(STORAGE_KEY_AUTOSAVE);e=e?JSON.parse(e):{};let t=localStorage.getItem(STORAGE_KEY_JSONSAVE);t=t?JSON.parse(t):{},e.isAutoSave=!0,e.title=getLang("autosave");const a=[e];for(let e in t)t[e].title=e,a.push(t[e]);const n=$("#load").find(".cover-inner");n.empty(),a.forEach(e=>{if(!e.timestamp||!e.json)return;const a=parseTimestamp(e.timestamp),o=$(`\n\t\t\t<div class="data-item">\n\t\t\t\t<div class="data-left">\n\t\t\t\t\t<img src="${e.thumb}">\n\t\t\t\t</div>\n\t\t\t\t<div class="data-center">\n\t\t\t\t\t<div class="data-title">${e.title}</div>\n\t\t\t\t\t<div class="data-date">${a}</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="data-right">\n\t\t\t\t\t<div class="data-delete">${getLang("delete")}</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`);o.get(0).onclick=(()=>{const t=JSON.parse(e.json);currentFilename=e.isAutoSave?"":e.title,readJSON(t),closeLoadJSON()}),o.find(".data-delete").get(0).onclick=(a=>{window.confirm(getLang("confirm-delete"))&&(e.isAutoSave?localStorage.removeItem(STORAGE_KEY_AUTOSAVE):(delete t[e.title],localStorage.setItem(STORAGE_KEY_JSONSAVE,JSON.stringify(t))),closeLoadJSON(),a.stopPropagation(),loadJSON())}),n.append(o)});const o=$(`<button>${getLang("cancel")}</button>`);o.get(0).onclick=closeLoadJSON,n.append(o),$("#load").show()}function saveJSON(){if(!currentFilename)return toastr.options={closeButton:!0,positionClass:"toast-bottom-right",timeOut:"2000"},void toastr.error(getLang("message-no-save-target"));const e=htmlToJSON(),t=JSON.stringify(e),a=(getDateStr(),getLang("short-"+canvasSetting.stage),getLang("short-"+canvasSetting.tide+"tide"),htmlToCanvas()),[n,o]=createCanvas(60,60);o.drawImage(a,0,0,60,60);const s=n.toDataURL("image/jpeg",.5);let r=localStorage.getItem(STORAGE_KEY_JSONSAVE);r=r?JSON.parse(r):{},currentFilename in r&&(r[currentFilename]={json:t,thumb:s,version:VERSION,timestamp:(new Date).getTime()},localStorage.setItem(STORAGE_KEY_JSONSAVE,JSON.stringify(r)),toastr.options={closeButton:!0,positionClass:"toast-bottom-right",timeOut:"2000"},toastr.success(getLang("message-success-save-json")))}function saveAsJSON(){const e=htmlToJSON(),t=JSON.stringify(e),a=getDateStr(),n=getLang("short-"+canvasSetting.stage),o=getLang("short-"+canvasSetting.tide+"tide"),s=currentFilename||`${n}${"ja"===USER_LANG?"":"_"}${o}_${a}`,r=htmlToCanvas(),[i,l]=createCanvas(60,60);l.drawImage(r,0,0,60,60);const c=i.toDataURL("image/jpeg",.5);myConfirm({textInput:s,funcOK:e=>{let a=localStorage.getItem(STORAGE_KEY_JSONSAVE);e in(a=a?JSON.parse(a):{})&&!window.confirm(getLang("confirm-overwrite"))||(a[e]={json:t,thumb:c,version:VERSION,timestamp:(new Date).getTime()},localStorage.setItem(STORAGE_KEY_JSONSAVE,JSON.stringify(a)),currentFilename=e,toastr.options={closeButton:!0,positionClass:"toast-bottom-right",timeOut:"2000"},toastr.success(getLang("message-success-save-as-json")))}})}function copyShareURL(){const e=htmlToJSON(),t=JSON.stringify(e),a=encodeURIComponent(t);copyStr(location.href.split("?")[0]+"?json="+a)&&(toastr.options={closeButton:!0,positionClass:"toast-bottom-right",timeOut:"2000"},toastr.success(getLang("message-success-copy-share-url")))}function downloadJSON(){const e=htmlToJSON(),t=JSON.stringify(e),a=getDateStr(),n=getLang("short-"+canvasSetting.stage),o=getLang("short-"+canvasSetting.tide+"tide");downloadText(t,`${n}${"ja"===USER_LANG?"":"_"}${o}_${a}`+".json")}function downloadPNG(){const e=htmlToCanvas(),t=getDateStr(),a=getLang("short-"+canvasSetting.stage),n=getLang("short-"+canvasSetting.tide+"tide");downloadCanvas(e,`${a}${"ja"===USER_LANG?"":"_"}${n}_${t}`+".png")}function checkHTCQuality(){const e=htmlToCanvas();$("#view-canvas").size()>0&&$("#view-canvas").remove(),$("#copy-canvas-area").append(e)}function updateSteelEelCanvas(){steeleelCtx.clearRect(0,0,STAGE_WIDTH,STAGE_HEIGHT),steeleelCtx.strokeStyle="#16531b",steeleelCtx.lineWidth=4,steeleelCtx.beginPath(),$(".stage-object.eel").each((e,t)=>{$(t).find(".stage-object-eel-node").each((e,t)=>{const a=parseFloat($(t).css("left")),n=parseFloat($(t).css("top"));0===e?steeleelCtx.moveTo(a,n):steeleelCtx.lineTo(a,n)})}),steeleelCtx.stroke()}function updateSteelheadCanvas(){steelheadCtx.clearRect(0,0,STAGE_WIDTH,STAGE_HEIGHT),$(".stage-object.steelhead").each((e,t)=>{if(ymapReady){const e=$(t).getXY();if(0<=e.x&&e.x<=STAGE_WIDTH&&0<=e.y&&e.y<=STAGE_HEIGHT){getDepthValueByImagedata(ymapImagedata,e.x,e.y);const a=parseInt($(t).attr("data-type"));drawSteelheadCircle(e.x,e.y,a)}}})}function addSteelEel(e={}){const t=canvasXYToStageXY(canvasSetting.canvasWidth/2,canvasSetting.canvasHeight/2);if(!stageObjectsReady)return void stageObjectsReadyFuncs.push(()=>{addSteelEel(e)});const a=canvasSetting,n=filterStageObjects("Obj_CoopSpawnPointZako","high"===a.tide?"CoopWater_2":"normal"===a.tide?"CoopWater_1":"CoopWater_0"),o=t.x,s=t.y,r=-n[0].ry;if(!e.hasOwnProperty("nodePositions")){const t=[];for(let e=0;e<15;e++)t.push({x:o,y:s,r:r});e.nodePositions=t}const i=$('<div class="stage-object eel"></div>'),l=[];for(let t=0,a=0;a<15;a++){const n=$('<img class="stage-object-eel-node">');let o;t+=0===a?0:1===a?9:19,n.minD=t,i.append(n),l.push(n),n.setXY(e.nodePositions[a].x,e.nodePositions[a].y),o=0===a?"./assets/img/stage-object/eel-head.png":a+1===15?"./assets/img/stage-object/eel-tail.png":"./assets/img/stage-object/eel-body.png",n.attr("src",o),n.elmvar("rotate",`${e.nodePositions[a].r}deg`),n.cssvar("--rotate",`${e.nodePositions[a].r}deg`)}const c=l[0];c.$family=i,c.$nodeList=l,c.addClass("stage-object-eel-head"),c.difX=-1,c.difY=-1,c.distanceTravelled=0,c.tracks=[];for(let t=e.nodePositions.length-1;t>=0;t--){const a=e.nodePositions[t];let n=0;if(t+1<e.nodePositions.length){n=getDistance(a,e.nodePositions[t+1])}c.tracks.unshift([a.x,a.y,n]),c.distanceTravelled+=n}$canvasContainer.$steeleelHead=null,c.myDraggable({parentType:"stage",drag:()=>{const e=c.getXY(),t=e.x,a=e.y,n=c.tracks[0][0],o=c.tracks[0][1],s=Math.sqrt((n-t)**2+(o-a)**2);if(c.distanceTravelled+=s,c.tracks.unshift([t,a,s]),c.tracks[10]){let e,n=0;for(e=0;e<c.tracks.length&&!((n+=c.tracks[e][2])>20);e++);e=Math.min(e,c.tracks.length-1);const o=getVectorAngle({x:t-c.tracks[e][0],y:a-c.tracks[e][1]})||0;c.elmvar("rotate",o-90),c.cssvar("--rotate",`${o-90}deg`)}let r=0,i=0;for(let e=1;e<l.length;e++){const t=l[e],a=t.minD;if(c.distanceTravelled>a){let n=0;for(let o=0;o<c.tracks.length;o++){const s=c.tracks[o];if((n+=s[2])>a){const l=(n-a)/s[2],g=c.tracks[o+1][0]+l*(c.tracks[o][0]-c.tracks[o+1][0]),d=c.tracks[o+1][1]+l*(c.tracks[o][1]-c.tracks[o+1][1]);t.setXY(g,d),i=o,r=e;break}}}}let g=c;for(let e=1;e<l.length;e++){const t=l[e],a=parseFloat(t.css("left")),n=parseFloat(t.css("top")),o=getVectorAngle({x:a-parseFloat(g.css("left")),y:n-parseFloat(g.css("top"))});t.elmvar("rotate",(o||-90)+90),t.cssvar("--rotate",`${(o||-90)+90}deg`),g=t}if(r+1===15)for(;c.tracks.length>i+2;)c.tracks.pop();updateSteelEelCanvas()}}).onLongTouch(()=>{const e=c.css("top"),t=c.css("left"),a=c.elmvar("rotate");for(let n=1;n<l.length;n++){const o=l[n];o.css("top",e),o.css("left",t),o.elmvar("rotate",a),o.cssvar("--rotate",`${a}deg`)}c.distanceTravelled=0,c.tracks=[[parseInt(t),parseInt(e),0]],updateSteelEelCanvas()}),$("#layer-steeleel").append(i),steeleelCtx.strokeStyle="#16531b",steeleelCtx.lineWidth=4,steeleelCtx.beginPath(),l.forEach((e,t)=>{const{x:a,y:n}=e.getXY();0===t?steeleelCtx.moveTo(a,n):steeleelCtx.lineTo(a,n)}),steeleelCtx.stroke(),onChangeCanvas()}function addSteelheadCircle(e={}){const t=canvasXYToStageXY(canvasSetting.canvasWidth/2,canvasSetting.canvasHeight/2);e=$.extend({},{x:t.x,y:t.y,type:0},e);const a=$('<div class="stage-object steelhead"></div>').attr("data-type",e.type).appendTo("#layer-steelhead");a.stop=(()=>{}),a.onMousedown(e=>{$canvasContainer.$steelheadIcon=a;const t=parseFloat(a.css("left")),n=parseFloat(a.css("top")),o=getPageXY(e),s=pageXYToStageXY(o.x,o.y);a.difX=t-s.x,a.difY=n-s.y,e.preventDefault(),e.stopPropagation()}).onShortTouch(e=>{const t=parseInt(a.attr("data-type"));a.attr("data-type",(t+1)%4),a.stop(a.get(0))}).setXY(e.x,e.y).myDraggable({parentType:"stage",stop:updateSteelheadCanvas}),ymapReady?updateSteelheadCanvas():ymapReadyFuncs.push(()=>{updateSteelheadCanvas()}),onChangeCanvas()}function drawSteelheadCircle(e,t,a=0){const n=steelheadCtx.getImageData(0,0,2400,2400);let o,s;o=getDepthValueByImagedata(ymapImagedata,e,t);const r=Math.max(0,parseInt(e-250)),i=Math.max(0,parseInt(t-250)),l=Math.min(ymapImagedata.width,parseInt(e+250)),c=Math.min(ymapImagedata.height,parseInt(t+250));for(let g=i;g<c;g++)for(let i=r;i<l;i++)if((s=getDepthValueByImagedata(ymapImagedata,i,g))>=canvasSetting.seaHeight){const r=Math.sqrt((i-e)*(i-e)+(g-t)*(g-t)),l=Math.abs(s-o);let c=!1;if(0===a&&r<200&&l<=50?c=[255,130,0]:1===a&&r<250&&l<=70?c=[255,210,0]:2===a&&r<200&&l<=10?c=[255,30,0]:3===a&&(r<200&&l<=10?c=[255,30,0]:r<200&&l<=50?c=[255,130,0]:r<250&&l<=70&&(c=[255,210,0])),c){const e=4*(g*ymapImagedata.width+i);n.data[e+0]=c[0],n.data[e+1]=c[1],n.data[e+2]=c[2],n.data[e+3]=130}}steelheadCtx.putImageData(n,0,0)}function addWeapon(e={}){if(!WEAPON.hasOwnProperty(`weapon-${e.id}`))return;const t=canvasXYToStageXY(canvasSetting.canvasWidth/2,canvasSetting.canvasHeight/2);e=$.extend({},{id:0,x:t.x,y:t.y,width:Math.round(48/canvasSetting.stageScale),height:Math.round(48/canvasSetting.stageScale),initialVisibleRange:!0,initialRotate:-canvasSetting.stageRotate,initialRotateRange:270},e);const a=WEAPON[`weapon-${e.id}`],n=e.width<=128?"weapon":"weapon-big",o=$('<div class="weapon-container" data-weapon-id="'+e.id+'" style="width: '+e.width+"px; height: "+e.height+'px;"><img src="./assets/img/'+n+"/"+e.id+'.png"><div class="range-container"><div class="range-line"></div><div class="v-range-line"></div><div class="range-end"></div><div class="range-far"></div><div class="v-range-end"></div><div class="v-range-far"></div><div class="range-near-end"></div><div class="range-blast"></div><div class="range-handle"></div></div></div>').attr("item-type","weapon").addClass("added-item").data("size","small").cssvar("--range",a.range/10*50+"px").cssvar("--blast",a.blast/10*50*2+"px").cssvar("--range-near",a.rangeNear/10*50+"px").cssvar("--range-far",a.rangeFar/10*50+"px").cssvar("--v-range",a.vRange/10*50+"px").cssvar("--v-range-far",a.vRangeFar/10*50+"px").appendTo("#layer-item").setXY(e.x,e.y).myDraggable({parentType:"stage"}).onShortTouch(e=>{o.find(".range-container").toggle()}).myResizable({resize:e=>{const t=$(e);if(t.getWH().width>128&&"big"!==t.data("size")){t.data("size","big");const e=t.find("img"),a=e.attr("src");e.attr("src",a.replace("/weapon/","/weapon-big/"))}}}).myRotatable({initialRotate:e.initialRotate,isTransformCenter:!0});o.find("img").setImageBorder(1),a.vRange>-1?(o.find(".range-line").addClass("h-range-line"),o.find(".range-end").addClass("h-range-end"),o.find(".range-far").addClass("h-range-far")):(o.find(".v-range-line").remove(),o.find(".v-range-end").remove(),o.find(".v-range-far").remove()),a.rangeNear<0&&o.find(".range-near-end").remove(),a.blast<0&&o.find(".range-blast").remove(),a.rangeFar<0&&o.find(".range-far").remove(),o.find(".range-container").myRotatable({initialRotate:e.initialRotateRange,handle:o.find(".range-handle")}),e.initialVisibleRange||o.find(".range-container").hide(),onChangeCanvas()}function addImage(e={}){const t=canvasXYToStageXY(canvasSetting.canvasWidth/2,canvasSetting.canvasHeight/2);e=$.extend({},{src:"",x:t.x,y:t.y,width:Math.round(48/canvasSetting.stageScale),height:Math.round(48/canvasSetting.stageScale),initialRotate:-canvasSetting.stageRotate},e);$('<div class="image-container" style="width: '+e.width+"px; height: "+e.height+'px;"><img src="'+e.src+'"></div>').attr("item-type","image").addClass("added-item").appendTo("#layer-item").setXY(e.x,e.y).myDraggable({parentType:"stage"}).myResizable({parentType:"stage"}).myRotatable({initialRotate:e.initialRotate,isTransformCenter:!0}).find("img").setImageBorder(1);onChangeCanvas()}function addTextarea(e={}){const t=canvasXYToStageXY(canvasSetting.canvasWidth/2,canvasSetting.canvasHeight/2);e=$.extend({},{text:getLang("object-adder-text-initial-value"),x:t.x,y:t.y,fontSize:Math.round(32/canvasSetting.stageScale),textColor:null,borderColor:null,fontFamily:null,initialRotate:-canvasSetting.stageRotate},textSetting,e);const a=$('<div class="textarea-container" ></div>'),n=$("<textarea>"+e.text+"</textarea>"),o=$("<div></div>");a.attr("item-type","text").addClass("added-item").elmvar("isFirstEdit",!0).setXY(e.x,e.y).append(n).append(o).appendTo("#layer-item").myDraggable({parentType:"stage"}).onDoubleClick(e=>{a.addClass("mydraggable-disable"),o.hide(),setTimeout(()=>{n.get(0).focus(),a.elmvar("isFirstEdit")&&(a.elmvar("isFirstEdit",!1),n.get(0).setSelectionRange(0,n.val().length))},100)}).myResizable({elmType:"text",ratio:2}).myRotatable({initialRotate:e.initialRotate,isTransformCenter:!0}),n.myOn("input",t=>{const a=window.getComputedStyle(n.get(0)),s=($("body"),$("<p>"+n.val()+"</p>").css({margin:"0",padding:"0",position:"fixed",left:"-100%",top:"-100%","word-break":"break-all","white-space":"nowrap","line-height":a.lineHeight,"letter-spacing":a.letterSpacing,"font-size":a.fontSize,"font-family":a.fontFamily,"font-weight":a.fontWeight}).appendTo("body")),r=n.val().split("\n");let i=-1,l=-1;for(let e=0;e<r.length;e++){const t=r[e];if(t){s.text(t);const e=s.width(),a=s.height();i<e&&(i=e),l<a&&(l=a)}}s.remove(),n.css({width:`${i}px`,height:`${l*r.length}px`}),o.css({width:`${i}px`,height:`${l*r.length}px`}),n.setTextBorder(Math.round(2/canvasSetting.stageScale),e.borderColor)}).myOn("focusout",e=>{a.removeClass("mydraggable-disable"),o.show()}).css("font-size",e.fontSize+"px").css("color",e.textColor).addClass("font-"+e.fontFamily).setTextBorder(Math.round(2/canvasSetting.stageScale),e.borderColor).elmvar("options",e).myTrigger("input"),onChangeCanvas()}window.addEventListener("DOMContentLoaded",()=>{console.log("Event: DOMContentLoaded"),init(),loadStorage(),readShareURL()||selectStage()});